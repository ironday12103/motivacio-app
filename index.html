<!DOCTYPE html>
<html lang="hu">
<head>
<meta charset="UTF-8">
<title>Motiv√°ci√≥ App</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<link rel="manifest" href="manifest.json">
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
body{
 margin:0;
 background:#000;
 color:#fff;
 font-family:Arial,Helvetica,sans-serif;
 display:flex;
 justify-content:center;
 align-items:center;
 height:100vh;
}
.app{
 width:100%;
 max-width:480px;
 height:96vh;
 background:#111;
 border-radius:28px;
 padding:18px;
 box-shadow:0 0 40px rgba(0,0,0,.9);
 overflow:auto;
}
.tabs{
 display:flex;
 gap:6px;
 margin-bottom:10px;
}
.tabs button{
 flex:1;
 border:none;
 border-radius:14px;
 padding:10px;
 background:#333;
 color:#fff;
 font-size:13px;
 cursor:pointer;
}
.tabs button.active{
 background:#ff9800;
 color:#000;
}
.view{display:none;}
.view.active{display:block;}

.stat-tabs{
 display:flex;
 gap:6px;
 margin-bottom:10px;
}
.stat-tabs button{
 flex:1;
 border:none;
 border-radius:14px;
 padding:10px;
 background:#333;
 color:#fff;
 cursor:pointer;
}
.stat-tabs button.active{
 background:#ff9800;
 color:#000;
}

#statChart{
 width:100%;
 height:240px;
 display:block;
}

.header-quote{text-align:center;font-size:14px;margin-bottom:8px;opacity:.9;}

.motivation-card{
 background:linear-gradient(135deg,#ff9800,#ff5722,#9c27b0);
 border-radius:22px;
 padding:14px;
 text-align:center;
}
.motivation-card img{
 width:100%;
 height:40vh;
 max-height:320px;
 object-fit:cover;
 border-radius:16px;
}
#authorTag{
 display:inline-block;
 padding:6px 14px;
 border-radius:16px;
 font-weight:bold;
 background:#222;
 color:#ff9800;
 margin-bottom:6px;
}
.big-quote{font-size:26px;font-weight:bold;}

textarea,input,select{
 width:100%;
 padding:12px;
 border-radius:14px;
 border:none;
 margin-top:8px;
 box-sizing:border-box;
}

button{
 width:100%;
 padding:12px;
 border:none;
 border-radius:14px;
 margin-top:8px;
 cursor:pointer;
}
.main{background:#ff9800;color:#000;}
.secondary{background:#333;color:#fff;}

.card{background:#1d1d1d;border-radius:16px;padding:12px;margin-bottom:8px;}
.stat-box{background:#222;border-radius:16px;padding:12px;margin-bottom:8px;}

.entry-meta{font-size:12px;opacity:.85;margin-top:6px;}
.entry-actions{margin-top:8px;display:flex;gap:6px;}
.small-btn{flex:1;padding:8px;border-radius:10px;font-size:13px;}
.small-danger{background:#b00020;color:#fff;}
.small-secondary{background:#333;color:#fff;}
</style>
</head>

<body>
<div class="app">

<div class="tabs">
 <button class="tab-btn active" data-target="mot">üî•</button>
 <button class="tab-btn" data-target="nap">üìì</button>
 <button class="tab-btn" data-target="sport">üèãÔ∏è</button>
 <button class="tab-btn" data-target="book">üìö</button>
 <button class="tab-btn" data-target="stat">üìä</button>
</div>

<div class="header-quote" id="dailyQuote"></div>

<div id="mot" class="view active">
 <div class="motivation-card">
  <img id="motImg" alt="Motiv√°ci√≥s k√©p">
  <div id="authorTag"></div>
  <div class="big-quote" id="quote"></div>
 </div>
 <button id="newQuoteBtn" class="main">√öj motiv√°ci√≥</button>
</div>

<div id="nap" class="view">
 <textarea id="journal" placeholder="√çrd le a napod..." rows="6"></textarea>
 <div class="card">Karakterek: <b><span id="charCount">0</span> / 90</b></div>
 <button class="secondary" id="saveJournalBtn" disabled>Ment√©s</button>
</div>

<div id="sport" class="view">
 <select id="stype"><option>Fut√°s</option><option>S√∫lyz√≥s</option></select>
 <button class="secondary" id="saveSportBtn">Ment√©s</button>
</div>

<div id="book" class="view">
 <input id="btitle" placeholder="K√∂nyv c√≠me">
 <button class="secondary" id="saveBookBtn">Ment√©s</button>
</div>

<div id="stat" class="view">
 <div class="stat-tabs">
  <button id="weekBtn" class="active">Heti</button>
  <button id="yearBtn">√âves</button>
 </div>

 <canvas id="statChart"></canvas>

 <div class="stat-box" id="statWrite"></div>
 <div class="stat-box" id="statSport"></div>
 <div class="stat-box" id="statBook"></div>

 <div class="card"><b>Napl√≥k</b><div id="statJournalList"></div></div>
 <div class="card"><b>Edz√©sek</b><div id="statSportList"></div></div>
 <div class="card"><b>K√∂nyvek</b><div id="statBookList"></div></div>
</div>

</div>

<script>
/*
 V√©gleges√≠tett f√°jl a k√©rt jav√≠t√°sokkal:
 - explicit DOM lek√©r√©s
 - event listenerek (nincs inline onclick)
 - szerkeszt√©s/t√∂rl√©s funkci√≥k
 - weekly/year stat sz≈±r√©skor is helyes szerkeszt√©s/t√∂rl√©s: az eredeti t√∂mb index√©t (_idx) adjuk √°t
 - localStorage getItem/setItem
 - XSS elleni escape, date formatting, k√©p fallback
*/

const quotes = [
 {a:"David Goggins", t:"A f√°jdalom ideiglenes.", i:"https://images.unsplash.com/photo-1517836357463-d25dfeac3438"},
 {a:"Elon Musk", t:"Ha fontos, megcsin√°lod.", i:"https://images.unsplash.com/photo-1518770660439-4636190af475"}
];

let statMode = "week";
let statChartObj = null;
const DOM = {};

function initDOM(){
 DOM.quote = document.getElementById('quote');
 DOM.motImg = document.getElementById('motImg');
 DOM.authorTag = document.getElementById('authorTag');
 DOM.dailyQuote = document.getElementById('dailyQuote');

 DOM.journal = document.getElementById('journal');
 DOM.charCount = document.getElementById('charCount');
 DOM.saveJournalBtn = document.getElementById('saveJournalBtn');

 DOM.stype = document.getElementById('stype');
 DOM.saveSportBtn = document.getElementById('saveSportBtn');

 DOM.btitle = document.getElementById('btitle');
 DOM.saveBookBtn = document.getElementById('saveBookBtn');

 DOM.weekBtn = document.getElementById('weekBtn');
 DOM.yearBtn = document.getElementById('yearBtn');

 DOM.statWrite = document.getElementById('statWrite');
 DOM.statSport = document.getElementById('statSport');
 DOM.statBook = document.getElementById('statBook');

 DOM.statJournalList = document.getElementById('statJournalList');
 DOM.statSportList = document.getElementById('statSportList');
 DOM.statBookList = document.getElementById('statBookList');

 DOM.statChart = document.getElementById('statChart');

 // Tabs
 document.querySelectorAll('.tab-btn').forEach(btn=>{
  btn.addEventListener('click', ()=> tab(btn, btn.dataset.target));
 });

 // Buttons
 document.getElementById('newQuoteBtn').addEventListener('click', newQuote);
 DOM.saveJournalBtn.addEventListener('click', saveJournal);
 DOM.saveSportBtn.addEventListener('click', saveSport);
 DOM.saveBookBtn.addEventListener('click', saveBook);

 // Stat mode
 DOM.weekBtn.addEventListener('click', ()=> switchStat('week'));
 DOM.yearBtn.addEventListener('click', ()=> switchStat('year'));

 // Inputs
 DOM.journal.addEventListener('input', countJournalChars);

 // Image error fallback
 DOM.motImg.addEventListener('error', ()=>{
  DOM.motImg.src = 'data:image/svg+xml;utf8,' + encodeURIComponent('<svg xmlns="http://www.w3.org/2000/svg" width="800" height="400"><rect width="100%" height="100%" fill="#222"/><text x="50%" y="50%" fill="#ff9800" font-size="24" font-family="Arial" text-anchor="middle" alignment-baseline="middle">K√©p nem el√©rhet≈ë</text></svg>');
 });

 // Deleg√°lt click listener a szerkeszt√©s/t√∂rl√©s gombokra
 [DOM.statJournalList, DOM.statSportList, DOM.statBookList].forEach(listEl => {
  if(!listEl) return;
  listEl.addEventListener('click', (ev)=>{
   const btn = ev.target.closest('button[data-action]');
   if(!btn) return;
   const action = btn.dataset.action;
   const type = btn.dataset.type;
   const idx = parseInt(btn.dataset.idx, 10);
   if(action === 'edit') editEntry(type, idx);
   if(action === 'delete') deleteEntry(type, idx);
  });
 });
}

function tab(btn,id){
 document.querySelectorAll(".tabs button").forEach(b=>b.classList.remove("active"));
 btn.classList.add("active");
 document.querySelectorAll(".view").forEach(v=>v.classList.remove("active"));
 document.getElementById(id).classList.add("active");
 if(id==="stat") setTimeout(loadStats,200);
}

function newQuote(){
 const q = quotes[Math.floor(Math.random()*quotes.length)];
 if(DOM.quote) DOM.quote.innerText = q.t;
 if(DOM.motImg){
  DOM.motImg.src = q.i;
  DOM.motImg.alt = q.t;
 }
 if(DOM.authorTag) DOM.authorTag.innerText = q.a;
 if(DOM.dailyQuote) DOM.dailyQuote.innerText = q.t + " ‚Äì " + q.a;
}

function countJournalChars(){
 if(!DOM.charCount || !DOM.journal || !DOM.saveJournalBtn) return;
 const len = DOM.journal.value.length;
 DOM.charCount.innerText = len;
 DOM.saveJournalBtn.disabled = len < 90;
}

function saveJournal(){
 if(!DOM.journal) return;
 const text = DOM.journal.value.trim();
 if(text.length < 90){ alert("A napl√≥nak legal√°bb 90 karakter hossz√∫nak kell lennie."); return; }
 let j = JSON.parse(localStorage.getItem('journal') || "[]");
 j.push({text:text, date:Date.now()});
 localStorage.setItem('journal', JSON.stringify(j));
 DOM.journal.value = "";
 countJournalChars();
 if(document.getElementById('stat').classList.contains('active')) loadStats();
}

function saveSport(){
 if(!DOM.stype) return;
 const type = DOM.stype.value ? DOM.stype.value.trim() : "";
 if(!type){ alert("Adj meg egy edz√©s t√≠pust."); return; }
 let s = JSON.parse(localStorage.getItem('sport') || "[]");
 s.push({type:type, date:Date.now()});
 localStorage.setItem('sport', JSON.stringify(s));
 if(document.getElementById('stat').classList.contains('active')) loadStats();
}

function saveBook(){
 if(!DOM.btitle) return;
 const title = DOM.btitle.value ? DOM.btitle.value.trim() : "";
 if(!title){ alert("Adj meg egy k√∂nyvc√≠met."); return; }
 let b = JSON.parse(localStorage.getItem('book') || "[]");
 b.push({title:title, date:Date.now()});
 localStorage.setItem('book', JSON.stringify(b));
 DOM.btitle.value = "";
 if(document.getElementById('stat').classList.contains('active')) loadStats();
}

function switchStat(m){
 statMode = m;
 DOM.weekBtn.classList.toggle("active", m==="week");
 DOM.yearBtn.classList.toggle("active", m==="year");
 loadStats();
}

function loadStats(){
 const now = Date.now(), week = 7 * 864e5;
 // beolvassuk az eredeti t√∂mb√∂ket
 const j = JSON.parse(localStorage.getItem('journal') || "[]");
 const s = JSON.parse(localStorage.getItem('sport') || "[]");
 const b = JSON.parse(localStorage.getItem('book') || "[]");

 // adjuk hozz√° az eredeti indexet (_idx), hogy a szerkeszt√©s/t√∂rl√©s pontosan az eredeti t√∂mbre hivatkozzon
 const jWithIdx = j.map((x,i) => ({...x, _idx: i}));
 const sWithIdx = s.map((x,i) => ({...x, _idx: i}));
 const bWithIdx = b.map((x,i) => ({...x, _idx: i}));

 const jf = statMode === "week" ? jWithIdx.filter(x => now - x.date < week) : jWithIdx;
 const sf = statMode === "week" ? sWithIdx.filter(x => now - x.date < week) : sWithIdx;
 const bf = statMode === "week" ? bWithIdx.filter(x => now - x.date < week) : bWithIdx;

 if(DOM.statWrite) DOM.statWrite.innerText = `üìì Napl√≥k: ${jf.length}`;
 if(DOM.statSport) DOM.statSport.innerText = `üèãÔ∏è Edz√©sek: ${sf.length}`;
 if(DOM.statBook) DOM.statBook.innerText = `üìö K√∂nyvek: ${bf.length}`;

 if(statChartObj) statChartObj.destroy();
 if(DOM.statChart){
  statChartObj = new Chart(DOM.statChart, {
   type: "bar",
   data: { labels: ["Napl√≥","Edz√©s","K√∂nyv"], datasets: [{ data: [jf.length, sf.length, bf.length], backgroundColor: ['#ff9800','#ff5722','#9c27b0'] }] },
   options: { responsive:true, maintainAspectRatio:false, plugins:{legend:{display:false}}, scales:{y:{beginAtZero:true}} }
  });
 }

 // Render lists, haszn√°ljuk az eredeti t√∂mb index√©t (_idx) data-idxk√©nt
 if(DOM.statJournalList) DOM.statJournalList.innerHTML = jf.map(x => `
  <div class="card">
    ${escapeHtml(truncate(x.text, 100))}
    <div class="entry-meta">${formatDate(x.date)}</div>
    <div class="entry-actions">
      <button class="small-btn small-secondary" data-action="edit" data-type="journal" data-idx="${x._idx}">Szerkeszt</button>
      <button class="small-btn small-danger" data-action="delete" data-type="journal" data-idx="${x._idx}">T√∂r√∂l</button>
    </div>
  </div>`).join("");

 if(DOM.statSportList) DOM.statSportList.innerHTML = sf.map(x => `
  <div class="card">
    ${escapeHtml(x.type)}
    <div class="entry-meta">${formatDate(x.date)}</div>
    <div class="entry-actions">
      <button class="small-btn small-secondary" data-action="edit" data-type="sport" data-idx="${x._idx}">Szerkeszt</button>
      <button class="small-btn small-danger" data-action="delete" data-type="sport" data-idx="${x._idx}">T√∂r√∂l</button>
    </div>
  </div>`).join("");

 if(DOM.statBookList) DOM.statBookList.innerHTML = bf.map(x => `
  <div class="card">
    ${escapeHtml(x.title)}
    <div class="entry-meta">${formatDate(x.date)}</div>
    <div class="entry-actions">
      <button class="small-btn small-secondary" data-action="edit" data-type="book" data-idx="${x._idx}">Szerkeszt</button>
      <button class="small-btn small-danger" data-action="delete" data-type="book" data-idx="${x._idx}">T√∂r√∂l</button>
    </div>
  </div>`).join("");
}

function editEntry(type, originalIdx){
 if(!['journal','sport','book'].includes(type)) return;
 const key = type;
 let arr = JSON.parse(localStorage.getItem(key) || "[]");
 if(originalIdx < 0 || originalIdx >= arr.length) return;
 const item = arr[originalIdx];
 if(type === 'journal'){
  const newText = prompt("Szerkeszd a napl√≥t (minimum 90 karakter):", item.text);
  if(newText === null) return;
  if(newText.trim().length < 90){ alert("A napl√≥nak legal√°bb 90 karakter hossz√∫nak kell lennie."); return; }
  arr[originalIdx].text = newText.trim();
 } else if(type === 'sport'){
  const newType = prompt("Szerkeszd az edz√©s t√≠pus√°t:", item.type);
  if(newType === null) return;
  if(!newType.trim()) return;
  arr[originalIdx].type = newType.trim();
 } else if(type === 'book'){
  const newTitle = prompt("Szerkeszd a k√∂nyv c√≠m√©t:", item.title);
  if(newTitle === null) return;
  if(!newTitle.trim()) return;
  arr[originalIdx].title = newTitle.trim();
 }
 localStorage.setItem(key, JSON.stringify(arr));
 loadStats();
}

function deleteEntry(type, originalIdx){
 if(!['journal','sport','book'].includes(type)) return;
 const key = type;
 let arr = JSON.parse(localStorage.getItem(key) || "[]");
 if(originalIdx < 0 || originalIdx >= arr.length) return;
 if(!confirm("Biztosan t√∂rl√∂d ezt a bejegyz√©st?")) return;
 arr.splice(originalIdx, 1);
 localStorage.setItem(key, JSON.stringify(arr));
 loadStats();
}

function formatDate(ts){
 if(!ts) return "";
 try{
  const d = new Date(ts);
  return d.toLocaleString('hu-HU', {year:'numeric',month:'short',day:'numeric',hour:'2-digit',minute:'2-digit'});
 }catch(e){ return ""; }
}

function truncate(str, max){
 if(!str) return "";
 return str.length > max ? str.slice(0, max-1) + '‚Ä¶' : str;
}

function escapeHtml(str){
 if(!str) return "";
 return String(str)
  .replace(/&/g, '&amp;')
  .replace(/</g, '&lt;')
  .replace(/>/g, '&gt;')
  .replace(/"/g, '&quot;')
  .replace(/'/g, '&#39;');
}

document.addEventListener('DOMContentLoaded', ()=>{
 initDOM();
 newQuote();
 countJournalChars();
 if(document.getElementById('stat').classList.contains('active')) loadStats();
});
</script>
</body>
</html>
