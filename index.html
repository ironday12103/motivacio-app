<!DOCTYPE html>
<html lang="hu">
<head>
<meta charset="UTF-8">
<title>Motiv√°ci√≥ App</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<link rel="manifest" href="manifest.json">
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
/* Alap st√≠lusok */
body{margin:0;background:#000;color:#fff;font-family:Arial,Helvetica,sans-serif;display:flex;justify-content:center;align-items:center;height:100vh;}
.app{width:100%;max-width:480px;height:96vh;background:#111;border-radius:28px;padding:18px;box-shadow:0 0 40px rgba(0,0,0,.9);overflow:auto;position:relative;}
.tabs{display:flex;gap:6px;margin-bottom:10px;}
.tabs button{flex:1;border:none;border-radius:14px;padding:10px;background:#333;color:#fff;font-size:13px;cursor:pointer;}
.tabs button.active{background:#ff9800;color:#000;}
.view{display:none;} .view.active{display:block;}
.stat-tabs{display:flex;gap:6px;margin-bottom:10px;}
.stat-tabs button{flex:1;border:none;border-radius:14px;padding:10px;background:#333;color:#fff;cursor:pointer;}
.stat-tabs button.active{background:#ff9800;color:#000;}

/* F≈ëoldali st√≠lusok */
.header-quote{text-align:center;font-size:14px;margin-bottom:8px;opacity:.9;}
.motivation-card{background:linear-gradient(135deg,#ff9800,#ff5722,#9c27b0);border-radius:22px;padding:14px;text-align:center;}
.author-photo{width:120px;height:120px;border-radius:50%;object-fit:cover;margin:8px auto 10px auto;border:3px solid rgba(255,255,255,0.12);background:#222;display:block;cursor:pointer;}
#authorTag{display:inline-block;padding:6px 14px;border-radius:16px;font-weight:bold;background:#222;color:#ff9800;margin-bottom:6px;}
#authorCredit{display:block;font-size:11px;opacity:0.85;margin-top:6px;color:#ddd;}
#authorCredit a{color:#ffd89b;text-decoration:underline;}
.big-quote{font-size:24px;font-weight:bold;line-height:1.2;}

/* Diagram kont√©ner ‚Äî fix hely √©s m√©ret */
.mini-stat-card{background:#1d1d1d;border-radius:16px;padding:10px;margin-top:12px;height:200px;box-sizing:border-box;}
.mini-stat-card canvas{width:100% !important;height:140px !important;display:block;}

/* Menu controls */
.menu-controls{display:flex;gap:8px;margin-bottom:8px;}
.menu-controls button{flex:1;padding:10px;border-radius:10px;border:none;background:#333;color:#fff;cursor:pointer}
.menu-controls button.active{background:#ff9800;color:#000}

/* Account view */
.account-card{background:#1d1d1d;padding:12px;border-radius:12px;}
.account-row{display:flex;justify-content:space-between;gap:8px;align-items:center}
.account-row b{font-size:14px}

/* shared controls */
textarea,input,select{width:100%;padding:12px;border-radius:14px;border:none;margin-top:8px;box-sizing:border-box;}
button{width:100%;padding:12px;border:none;border-radius:14px;margin-top:8px;cursor:pointer;}
.main{background:#ff9800;color:#000;} .secondary{background:#333;color:#fff;}
.card{background:#1d1d1d;border-radius:16px;padding:12px;margin-bottom:8px;}
.stat-box{background:#222;border-radius:16px;padding:12px;margin-bottom:8px;}
.entry-meta{font-size:12px;opacity:.85;margin-top:6px;}
.entry-actions{margin-top:8px;display:flex;gap:6px;}
.small-btn{flex:1;padding:8px;border-radius:10px;font-size:13px;}
.small-danger{background:#b00020;color:#fff;} .small-secondary{background:#333;color:#fff;}

/* Modal / Undo / IO styles (unchanged) */
.modal-backdrop{position:fixed;left:0;top:0;right:0;bottom:0;background:rgba(0,0,0,0.6);display:flex;align-items:center;justify-content:center;z-index:2000;}
.modal{background:#111;border-radius:12px;padding:16px;width:92%;max-width:420px;box-shadow:0 8px 24px rgba(0,0,0,0.6);}
.modal header{font-weight:bold;margin-bottom:8px;} .modal .row{margin-top:8px;} .modal .actions{display:flex;gap:8px;margin-top:12px;} .modal .actions button{flex:1}
#undoBar{position:fixed;left:50%;transform:translateX(-50%);bottom:18px;background:#222;color:#fff;padding:10px 12px;border-radius:12px;display:flex;gap:8px;align-items:center;z-index:3000;box-shadow:0 8px 20px rgba(0,0,0,0.6);display:none;}
.io-actions{display:flex;gap:8px;margin-top:8px;flex-wrap:wrap;} .io-actions button{flex:1;padding:10px;border-radius:10px} .file-input{display:none}
</style>
</head>

<body>
<div class="app">

  <div class="tabs">
    <button class="tab-btn active" data-target="mot">üî•</button>
    <button class="tab-btn" data-target="nap">üìì</button>
    <button class="tab-btn" data-target="sport">üèãÔ∏è</button>
    <button class="tab-btn" data-target="book">üìö</button>
    <button class="tab-btn" data-target="stat">üìä</button>
    <button class="tab-btn" data-target="menu">‚ò∞</button>
  </div>

  <div class="header-quote" id="dailyQuote"></div>

  <!-- F≈êOLDAL -->
  <div id="mot" class="view active">
    <div class="motivation-card">
      <img id="authorPhoto" class="author-photo" alt="Szerz≈ë k√©pe" title="Kattints a forr√°s megnyit√°s√°hoz ha el√©rhet≈ë">
      <div id="authorTag"></div>
      <div id="authorCredit"></div>
      <div class="big-quote" id="quote"></div>
    </div>
    <button id="newQuoteBtn" class="main">√öj motiv√°ci√≥</button>
  </div>

  <!-- NAPL√ì -->
  <div id="nap" class="view">
    <textarea id="journal" placeholder="√çrd le a napod..." rows="6"></textarea>
    <div class="card">Karakterek: <b><span id="charCount">0</span> / 90</b></div>
    <button class="secondary" id="saveJournalBtn" disabled>Ment√©s</button>
  </div>

  <!-- SPORT -->
  <div id="sport" class="view">
    <select id="stype"><option>Fut√°s</option><option>S√∫lyz√≥s</option></select>
    <button class="secondary" id="saveSportBtn">Ment√©s</button>
  </div>

  <!-- K√ñNYV -->
  <div id="book" class="view">
    <input id="btitle" placeholder="K√∂nyv c√≠me">
    <button class="secondary" id="saveBookBtn">Ment√©s</button>
  </div>

  <!-- STAT (r√©szletes) -->
  <div id="stat" class="view">
    <div class="stat-tabs">
      <button id="weekBtn" class="active">Heti</button>
      <button id="yearBtn">√âves</button>
    </div>

    <canvas id="statChart"></canvas>

    <div class="stat-box" id="statWrite"></div>
    <div class="stat-box" id="statSport"></div>
    <div class="stat-box" id="statBook"></div>

    <div class="card"><b>Napl√≥k</b><div id="statJournalList"></div></div>
    <div class="card"><b>Edz√©sek</b><div id="statSportList"></div></div>
    <div class="card"><b>K√∂nyvek</b><div id="statBookList"></div></div>

    <div class="card">
      <b>Adatok (Export / Import)</b>
      <div class="io-actions">
        <button id="exportBtn" class="secondary">Export√°l√°s JSON</button>
        <button id="importBtn" class="secondary">Import√°l√°s JSON</button>
        <input id="fileInput" class="file-input" type="file" accept="application/json">
      </div>
    </div>
  </div>

  <!-- MEN√ú: Diagram + Fi√≥k -->
  <div id="menu" class="view">
    <div class="menu-controls">
      <button id="diagramBtn" class="active">Diagram</button>
      <button id="accountBtn">Fi√≥k</button>
    </div>

    <div id="diagramView">
      <div class="mini-stat-card">
        <canvas id="miniChart" height="140"></canvas>
        <div style="margin-top:8px;font-size:13px;color:#ddd" id="miniStatText"></div>
      </div>
    </div>

    <div id="accountView" style="display:none; margin-top:12px;">
      <div class="account-card">
        <div class="account-row"><b>N√©v</b><div id="accName">‚Äî</div></div>
        <div class="account-row" style="margin-top:8px;"><b>E-mail</b><div id="accEmail">‚Äî</div></div>
        <div style="margin-top:10px;display:flex;gap:8px;">
          <button id="editAccountBtn" class="secondary">Szerkeszt</button>
          <button id="clearAccountBtn" class="small-btn small-danger" style="width:auto">T√∂r√∂l</button>
        </div>
      </div>
    </div>
  </div>

</div>

<!-- Modal -->
<div id="modalBackdrop" class="modal-backdrop" style="display:none">
  <div class="modal" role="dialog" aria-modal="true" aria-labelledby="modalTitle">
    <header id="modalTitle">Szerkeszt√©s</header>
    <div id="modalBody">
      <div class="row" id="modalFieldJournal" style="display:none">
        <label for="modalJournal">Napl√≥</label>
        <textarea id="modalJournal" rows="6"></textarea>
        <div class="card">Karakterek: <b><span id="modalCharCount">0</span> / 90</b></div>
      </div>
      <div class="row" id="modalFieldSport" style="display:none">
        <label for="modalSportType">Edz√©s t√≠pus</label>
        <input id="modalSportType" />
      </div>
      <div class="row" id="modalFieldBook" style="display:none">
        <label for="modalBookTitle">K√∂nyv c√≠me</label>
        <input id="modalBookTitle" />
      </div>
    </div>
    <div class="actions">
      <button id="modalSaveBtn" class="main">Ment√©s</button>
      <button id="modalCancelBtn" class="secondary">M√©gse</button>
    </div>
  </div>
</div>

<!-- Undo bar -->
<div id="undoBar">
  <span id="undoMsg">Bejegyz√©s t√∂r√∂lve</span>
  <button id="undoBtn" class="main">Vissza√°ll√≠t</button>
  <button id="undoDismiss" class="secondary">Bez√°r</button>
</div>

<script>
/* Teljes√≠t√©s: a miniChart egyszer j√∂n l√©tre (createMiniChart), responsive:false √©s animation:false.
   updateMiniChart csak friss√≠ti az adatot, √≠gy a diagram nem okoz layout-mozg√°st. */

const quotes = [
 {a:"David Goggins", t:"A f√°jdalom ideiglenes.", p:""},
 {a:"Elon Musk", t:"Ha fontos, megcsin√°lod.", p:""},
 {a:"Steve Jobs", t:"Az √©letedet az hat√°rozza meg, amit teszel, nem az, amit mondasz.", p:"https://upload.wikimedia.org/wikipedia/commons/6/6c/Steve_Jobs_Headshot_2010-CROP.jpg", credit:"Matthew Yohe / CC BY-SA 3.0", creditUrl:"https://en.wikipedia.org/wiki/File:Steve_Jobs_Headshot_2010-CROP.jpg"},
 {a:"Nelson Mandela", t:"Mindig √∫gy t≈±nik lehetetlennek, am√≠g meg nem csin√°lod.", p:""},
 {a:"Winston Churchill", t:"Soha ne add fel.", p:""},
 {a:"Confucius", t:"A legt√°volabbi utaz√°s is egy l√©p√©ssel kezd≈ëdik.", p:""},
 {a:"Eleanor Roosevelt", t:"Ne f√©lj megpr√≥b√°lni.", p:""},
 {a:"Albert Einstein", t:"Pr√≥b√°lj meg mindig jobb lenni.", p:""},
 {a:"Mark Twain", t:"Az oda√©r√©s titka az, hogy elindulsz.", p:""},
 {a:"Henry Ford", t:"Ha azt hiszed, hogy k√©pes vagy r√°, m√°r f√©lig k√©sz vagy.", p:""}
];

let statMode = "week";
let statChartObj = null;
let miniChartObj = null;
const DOM = {};
let undoStack = [];
let undoTimeouts = [];
let currentEdit = null;

function initDOM(){
  DOM.authorPhoto = document.getElementById('authorPhoto');
  DOM.authorTag = document.getElementById('authorTag');
  DOM.authorCredit = document.getElementById('authorCredit');
  DOM.quote = document.getElementById('quote');
  DOM.dailyQuote = document.getElementById('dailyQuote');

  DOM.journal = document.getElementById('journal');
  DOM.charCount = document.getElementById('charCount');
  DOM.saveJournalBtn = document.getElementById('saveJournalBtn');

  DOM.stype = document.getElementById('stype');
  DOM.saveSportBtn = document.getElementById('saveSportBtn');

  DOM.btitle = document.getElementById('btitle');
  DOM.saveBookBtn = document.getElementById('saveBookBtn');

  DOM.weekBtn = document.getElementById('weekBtn');
  DOM.yearBtn = document.getElementById('yearBtn');

  DOM.statWrite = document.getElementById('statWrite');
  DOM.statSport = document.getElementById('statSport');
  DOM.statBook = document.getElementById('statBook');

  DOM.statJournalList = document.getElementById('statJournalList');
  DOM.statSportList = document.getElementById('statSportList');
  DOM.statBookList = document.getElementById('statBookList');

  DOM.statChart = document.getElementById('statChart');
  DOM.miniChart = document.getElementById('miniChart');
  DOM.miniStatText = document.getElementById('miniStatText');

  DOM.diagramBtn = document.getElementById('diagramBtn');
  DOM.accountBtn = document.getElementById('accountBtn');
  DOM.diagramView = document.getElementById('diagramView');
  DOM.accountView = document.getElementById('accountView');

  DOM.accName = document.getElementById('accName');
  DOM.accEmail = document.getElementById('accEmail');
  DOM.editAccountBtn = document.getElementById('editAccountBtn');
  DOM.clearAccountBtn = document.getElementById('clearAccountBtn');

  DOM.modalBackdrop = document.getElementById('modalBackdrop');
  DOM.modalJournal = document.getElementById('modalJournal');
  DOM.modalCharCount = document.getElementById('modalCharCount');
  DOM.modalFieldJournal = document.getElementById('modalFieldJournal');
  DOM.modalFieldSport = document.getElementById('modalFieldSport');
  DOM.modalSportType = document.getElementById('modalSportType');
  DOM.modalFieldBook = document.getElementById('modalFieldBook');
  DOM.modalBookTitle = document.getElementById('modalBookTitle');
  DOM.modalSaveBtn = document.getElementById('modalSaveBtn');
  DOM.modalCancelBtn = document.getElementById('modalCancelBtn');

  DOM.undoBar = document.getElementById('undoBar');
  DOM.undoBtn = document.getElementById('undoBtn');
  DOM.undoDismiss = document.getElementById('undoDismiss');
  DOM.undoMsg = document.getElementById('undoMsg');

  DOM.exportBtn = document.getElementById('exportBtn');
  DOM.importBtn = document.getElementById('importBtn');
  DOM.fileInput = document.getElementById('fileInput');

  document.querySelectorAll('.tab-btn').forEach(btn=>{
    btn.addEventListener('click', ()=> {
      document.querySelectorAll('.tab-btn').forEach(b=>b.classList.remove('active'));
      btn.classList.add('active');
      const id = btn.dataset.target;
      document.querySelectorAll('.view').forEach(v=>v.classList.remove('active'));
      const tgt = document.getElementById(id);
      if(tgt) tgt.classList.add('active');
      if(id === 'stat') setTimeout(loadStats,200);
    });
  });

  document.getElementById('newQuoteBtn').addEventListener('click', newQuote);

  if(DOM.diagramBtn) DOM.diagramBtn.addEventListener('click', ()=> { DOM.diagramBtn.classList.add('active'); DOM.accountBtn.classList.remove('active'); DOM.diagramView.style.display='block'; DOM.accountView.style.display='none'; loadMiniStats(); });
  if(DOM.accountBtn) DOM.accountBtn.addEventListener('click', ()=> { DOM.accountBtn.classList.add('active'); DOM.diagramBtn.classList.remove('active'); DOM.diagramView.style.display='none'; DOM.accountView.style.display='block'; loadAccountInfo(); });

  if (DOM.saveJournalBtn) DOM.saveJournalBtn.addEventListener('click', saveJournal);
  if (DOM.saveSportBtn) DOM.saveSportBtn.addEventListener('click', saveSport);
  if (DOM.saveBookBtn) DOM.saveBookBtn.addEventListener('click', saveBook);

  if (DOM.weekBtn) DOM.weekBtn.addEventListener('click', ()=> switchStat('week'));
  if (DOM.yearBtn) DOM.yearBtn.addEventListener('click', ()=> switchStat('year'));

  if (DOM.journal) DOM.journal.addEventListener('input', countJournalChars);

  if (DOM.authorPhoto) DOM.authorPhoto.addEventListener('click', ()=>{
    const current = DOM.authorPhoto.dataset.sourceUrl;
    if(current) window.open(current,'_blank','noopener');
  });

  if(DOM.authorPhoto){
    DOM.authorPhoto.addEventListener('error', ()=>{
      DOM.authorPhoto.src = 'data:image/svg+xml;utf8,' + encodeURIComponent('<svg xmlns="http://www.w3.org/2000/svg" width="120" height="120"><rect width="100%" height="100%" fill="#222"/><circle cx="60" cy="40" r="28" fill="#ff9800"/><rect x="20" y="80" width="80" height="12" fill="#444"/></svg>');
    });
  }

  [DOM.statJournalList, DOM.statSportList, DOM.statBookList].forEach(listEl=>{
    if(!listEl) return;
    listEl.addEventListener('click', ev=>{
      const btn = ev.target.closest('button[data-action]');
      if(!btn) return;
      const action = btn.dataset.action;
      const type = btn.dataset.type;
      const idx = parseInt(btn.dataset.idx,10);
      if(action === 'edit') openEditModal(type, idx);
      if(action === 'delete') performDelete(type, idx);
    });
  });

  if (DOM.modalSaveBtn) DOM.modalSaveBtn.addEventListener('click', modalSave);
  if (DOM.modalCancelBtn) DOM.modalCancelBtn.addEventListener('click', closeModal);
  if (DOM.modalJournal) DOM.modalJournal.addEventListener('input', ()=> DOM.modalCharCount.innerText = DOM.modalJournal.value.length);

  if (DOM.undoBtn) DOM.undoBtn.addEventListener('click', undoLast);
  if (DOM.undoDismiss) DOM.undoDismiss.addEventListener('click', hideUndoBar);

  if (DOM.exportBtn) DOM.exportBtn.addEventListener('click', exportData);
  if (DOM.importBtn) DOM.importBtn.addEventListener('click', ()=> DOM.fileInput.click());
  if (DOM.fileInput) DOM.fileInput.addEventListener('change', importFile);

  if (DOM.editAccountBtn) DOM.editAccountBtn.addEventListener('click', openAccountEditor);
  if (DOM.clearAccountBtn) DOM.clearAccountBtn.addEventListener('click', clearAccount);
}

/* ---- Mini chart: create once, update only ---- */
function createMiniChart(){
  if(!DOM.miniChart) return;
  const ctx = DOM.miniChart.getContext('2d');
  miniChartObj = new Chart(ctx, {
    type:'doughnut',
    data:{labels:['Napl√≥','Edz√©s','K√∂nyv'],datasets:[{data:[0,0,0],backgroundColor:['#ff9800','#ff5722','#9c27b0']}]},
    options:{
      responsive:false,
      maintainAspectRatio:false,
      animation:false,
      plugins:{legend:{position:'bottom',labels:{color:'#ddd'}}}
    }
  });
}
function updateMiniChart(counts){
  if(!miniChartObj){
    createMiniChart();
  }
  if(!miniChartObj) return;
  miniChartObj.data.datasets[0].data = counts;
  miniChartObj.update('none'); // friss√≠t√©s anim√°ci√≥ n√©lk√ºl
}
function loadMiniStats(){
  if(!DOM.miniChart) return;
  const j = JSON.parse(localStorage.getItem('journal') || "[]");
  const s = JSON.parse(localStorage.getItem('sport') || "[]");
  const b = JSON.parse(localStorage.getItem('book') || "[]");
  const counts = [j.length, s.length, b.length];
  updateMiniChart(counts);
  if(DOM.miniStatText) DOM.miniStatText.innerText = `Napl√≥k: ${counts[0]} ‚Äî Edz√©sek: ${counts[1]} ‚Äî K√∂nyvek: ${counts[2]}`;
}

/* ---- Egy√©b funkci√≥k (id√©zet, ment√©s, stat, modal, undo, export/import, account) ---- */
function newQuote(){
  const q = quotes[Math.floor(Math.random()*quotes.length)];
  if(DOM.quote) DOM.quote.innerText = q.t;
  const avatar = q.p ? q.p : ('https://i.pravatar.cc/150?u=' + encodeURIComponent(q.a));
  if(DOM.authorPhoto){ DOM.authorPhoto.src = avatar; DOM.authorPhoto.alt = q.a; DOM.authorPhoto.dataset.sourceUrl = q.creditUrl || ''; }
  if(DOM.authorTag) DOM.authorTag.innerText = q.a;
  if(DOM.authorCredit){ if(q.credit) DOM.authorCredit.innerHTML = `<a href="${escapeHtml(q.creditUrl||'#')}" target="_blank" rel="noopener noreferrer">${escapeHtml(q.credit)}</a>`; else DOM.authorCredit.innerHTML = ''; }
  if(DOM.dailyQuote) DOM.dailyQuote.innerText = q.t + " ‚Äì " + q.a;
  loadMiniStats();
}

function countJournalChars(){ if(!DOM.charCount||!DOM.journal||!DOM.saveJournalBtn) return; const len=DOM.journal.value.length; DOM.charCount.innerText=len; DOM.saveJournalBtn.disabled = len<90; }
function saveJournal(){ if(!DOM.journal) return; const text=DOM.journal.value.trim(); if(text.length<90){alert("A napl√≥nak legal√°bb 90 karakter hossz√∫nak kell lennie."); return;} let j=JSON.parse(localStorage.getItem('journal')||"[]"); j.push({text:text,date:Date.now()}); localStorage.setItem('journal',JSON.stringify(j)); DOM.journal.value=""; countJournalChars(); if(document.getElementById('stat').classList.contains('active')) loadStats(); loadMiniStats(); }
function saveSport(){ if(!DOM.stype) return; const type=DOM.stype.value?DOM.stype.value.trim():""; if(!type){alert("Adj meg egy edz√©s t√≠pust.");return;} let s=JSON.parse(localStorage.getItem('sport')||"[]"); s.push({type:type,date:Date.now()}); localStorage.setItem('sport',JSON.stringify(s)); if(document.getElementById('stat').classList.contains('active')) loadStats(); loadMiniStats(); }
function saveBook(){ if(!DOM.btitle) return; const title=DOM.btitle.value?DOM.btitle.value.trim():""; if(!title){alert("Adj meg egy k√∂nyvc√≠met.");return;} let b=JSON.parse(localStorage.getItem('book')||"[]"); b.push({title:title,date:Date.now()}); localStorage.setItem('book',JSON.stringify(b)); DOM.btitle.value=""; if(document.getElementById('stat').classList.contains('active')) loadStats(); loadMiniStats(); }

function switchStat(m){ statMode=m; if(DOM.weekBtn) DOM.weekBtn.classList.toggle("active",m==="week"); if(DOM.yearBtn) DOM.yearBtn.classList.toggle("active",m==="year"); loadStats(); }
function loadStats(){
  const now=Date.now(), week=7*864e5;
  const j=JSON.parse(localStorage.getItem('journal')||"[]");
  const s=JSON.parse(localStorage.getItem('sport')||"[]");
  const b=JSON.parse(localStorage.getItem('book')||"[]");
  const jWithIdx = j.map((x,i)=>({...x,_idx:i}));
  const sWithIdx = s.map((x,i)=>({...x,_idx:i}));
  const bWithIdx = b.map((x,i)=>({...x,_idx:i}));
  const jf = statMode==="week" ? jWithIdx.filter(x=>now-x.date<week) : jWithIdx;
  const sf = statMode==="week" ? sWithIdx.filter(x=>now-x.date<week) : sWithIdx;
  const bf = statMode==="week" ? bWithIdx.filter(x=>now-x.date<week) : bWithIdx;
  if(DOM.statWrite) DOM.statWrite.innerText = `üìì Napl√≥k: ${jf.length}`;
  if(DOM.statSport) DOM.statSport.innerText = `üèãÔ∏è Edz√©sek: ${sf.length}`;
  if(DOM.statBook) DOM.statBook.innerText = `üìö K√∂nyvek: ${bf.length}`;
  if(statChartObj) statChartObj.destroy();
  if(DOM.statChart){
    statChartObj = new Chart(DOM.statChart, { type:"bar", data:{labels:["Napl√≥","Edz√©s","K√∂nyv"],datasets:[{data:[jf.length,sf.length,bf.length],backgroundColor:['#ff9800','#ff5722','#9c27b0']}]}, options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{display:false}},scales:{y:{beginAtZero:true}}} });
  }
  if(DOM.statJournalList) DOM.statJournalList.innerHTML = jf.map(x=>`<div class="card">${escapeHtml(truncate(x.text,200))}<div class="entry-meta">${formatDate(x.date)}</div><div class="entry-actions"><button class="small-btn small-secondary" data-action="edit" data-type="journal" data-idx="${x._idx}">Szerkeszt</button><button class="small-btn small-danger" data-action="delete" data-type="journal" data-idx="${x._idx}">T√∂r√∂l</button></div></div>`).join("");
  if(DOM.statSportList) DOM.statSportList.innerHTML = sf.map(x=>`<div class="card">${escapeHtml(x.type)}<div class="entry-meta">${formatDate(x.date)}</div><div class="entry-actions"><button class="small-btn small-secondary" data-action="edit" data-type="sport" data-idx="${x._idx}">Szerkeszt</button><button class="small-btn small-danger" data-action="delete" data-type="sport" data-idx="${x._idx}">T√∂r√∂l</button></div></div>`).join("");
  if(DOM.statBookList) DOM.statBookList.innerHTML = bf.map(x=>`<div class="card">${escapeHtml(x.title)}<div class="entry-meta">${formatDate(x.date)}</div><div class="entry-actions"><button class="small-btn small-secondary" data-action="edit" data-type="book" data-idx="${x._idx}">Szerkeszt</button><button class="small-btn small-danger" data-action="delete" data-type="book" data-idx="${x._idx}">T√∂r√∂l</button></div></div>`).join("");
}

/* Account */
function loadAccountInfo(){ const acc=JSON.parse(localStorage.getItem('account')||"{}"); if(DOM.accName) DOM.accName.innerText = acc.name || '‚Äî'; if(DOM.accEmail) DOM.accEmail.innerText = acc.email || '‚Äî'; }
function openAccountEditor(){ const acc=JSON.parse(localStorage.getItem('account')||"{}"); const name=prompt("N√©v:", acc.name||""); if(name===null) return; const email=prompt("E-mail:", acc.email||""); if(email===null) return; localStorage.setItem('account',JSON.stringify({name:name.trim(),email:email.trim()})); loadAccountInfo(); }
function clearAccount(){ if(!confirm("Biztosan t√∂rl√∂d a fi√≥kadatokat?")) return; localStorage.removeItem('account'); loadAccountInfo(); }

/* Modal / edit / delete / undo / import/export (√∂sszefoglalva) */
function openEditModal(type, originalIdx){ currentEdit={type,idx:originalIdx}; DOM.modalFieldJournal.style.display='none'; DOM.modalFieldSport.style.display='none'; DOM.modalFieldBook.style.display='none'; const arr=JSON.parse(localStorage.getItem(type)||"[]"); const item=arr[originalIdx]||{}; if(type==='journal'){DOM.modalFieldJournal.style.display='';DOM.modalJournal.value=item.text||'';DOM.modalCharCount.innerText=DOM.modalJournal.value.length;} if(type==='sport'){DOM.modalFieldSport.style.display='';DOM.modalSportType.value=item.type||'';} if(type==='book'){DOM.modalFieldBook.style.display='';DOM.modalBookTitle.value=item.title||'';} DOM.modalBackdrop.style.display='flex'; setTimeout(()=>{ if(type==='journal')DOM.modalJournal.focus(); if(type==='sport')DOM.modalSportType.focus(); if(type==='book')DOM.modalBookTitle.focus(); },50); }
function closeModal(){ currentEdit=null; DOM.modalBackdrop.style.display='none'; }
function modalSave(){ if(!currentEdit) return; const {type,idx}=currentEdit; let arr=JSON.parse(localStorage.getItem(type)||"[]"); if(type==='journal'){ const newText=DOM.modalJournal.value.trim(); if(newText.length<90){alert("A napl√≥nak legal√°bb 90 karakter hossz√∫nak kell lennie."); return;} if(idx>=0&&idx<arr.length){arr[idx].text=newText;arr[idx].date=Date.now();} else arr.push({text:newText,date:Date.now()}); } else if(type==='sport'){ const newType=DOM.modalSportType.value.trim(); if(!newType){alert("Adj meg egy edz√©s t√≠pust.");return;} if(idx>=0&&idx<arr.length){arr[idx].type=newType;arr[idx].date=Date.now();} else arr.push({type:newType,date:Date.now()}); } else if(type==='book'){ const newTitle=DOM.modalBookTitle.value.trim(); if(!newTitle){alert("Adj meg egy k√∂nyvc√≠met.");return;} if(idx>=0&&idx<arr.length){arr[idx].title=newTitle;arr[idx].date=Date.now();} else arr.push({title:newTitle,date:Date.now()}); } localStorage.setItem(type,JSON.stringify(arr)); closeModal(); loadStats(); loadMiniStats(); }
function performDelete(type, originalIdx){ let arr=JSON.parse(localStorage.getItem(type)||"[]"); if(originalIdx<0||originalIdx>=arr.length) return; const [removed]=arr.splice(originalIdx,1); localStorage.setItem(type,JSON.stringify(arr)); const undoEntry={type,data:removed,idx:originalIdx}; undoStack.push(undoEntry); if(DOM.undoMsg) DOM.undoMsg.innerText=`T√∂r√∂lve: ${truncate(removed.text||removed.type||removed.title||'',40)}`; if(DOM.undoBar) DOM.undoBar.style.display='flex'; loadStats(); loadMiniStats(); const to=setTimeout(()=>{ const pos=undoStack.indexOf(undoEntry); if(pos>=0) undoStack.splice(pos,1); if(undoStack.length===0 && DOM.undoBar) DOM.undoBar.style.display='none'; },8000); undoTimeouts.push(to); }
function undoLast(){ if(undoStack.length===0) return; const entry=undoStack.pop(); const t=undoTimeouts.pop(); if(t) clearTimeout(t); let arr=JSON.parse(localStorage.getItem(entry.type)||"[]"); const insertIdx=Math.min(Math.max(0,entry.idx),arr.length); arr.splice(insertIdx,0,entry.data); localStorage.setItem(entry.type,JSON.stringify(arr)); loadStats(); loadMiniStats(); if(undoStack.length===0 && DOM.undoBar) DOM.undoBar.style.display='none'; }
function hideUndoBar(){ undoStack=[]; undoTimeouts.forEach(t=>clearTimeout(t)); undoTimeouts=[]; if(DOM.undoBar) DOM.undoBar.style.display='none'; }

/* Export / Import */
function exportData(){ const payload={journal:JSON.parse(localStorage.getItem('journal')||"[]"),sport:JSON.parse(localStorage.getItem('sport')||"[]"),book:JSON.parse(localStorage.getItem('book')||"[]"),exportedAt:Date.now()}; const blob=new Blob([JSON.stringify(payload,null,2)],{type:'application/json'}); const url=URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download=`motivacio-export-${new Date().toISOString().slice(0,10)}.json`; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url); }
function importFile(ev){ const f=ev.target.files&&ev.target.files[0]; if(!f) return; const reader=new FileReader(); reader.onload=function(e){ try{ const data=JSON.parse(e.target.result); if(typeof data!=='object') throw new Error('Hib√°s f√°jl.'); const j=Array.isArray(data.journal)?data.journal:[]; const s=Array.isArray(data.sport)?data.sport:[]; const b=Array.isArray(data.book)?data.book:[]; const wantReplace=confirm("Fel√ºl√≠rja a helyi adatokat az import√°ltakkal? (OK = fel√ºl√≠r, M√©gse = √∂sszevon√°s)"); if(wantReplace){ localStorage.setItem('journal',JSON.stringify(j)); localStorage.setItem('sport',JSON.stringify(s)); localStorage.setItem('book',JSON.stringify(b)); } else { const curJ=JSON.parse(localStorage.getItem('journal')||"[]"); const curS=JSON.parse(localStorage.getItem('sport')||"[]"); const curB=JSON.parse(localStorage.getItem('book')||"[]"); localStorage.setItem('journal',JSON.stringify(curJ.concat(j))); localStorage.setItem('sport',JSON.stringify(curS.concat(s))); localStorage.setItem('book',JSON.stringify(curB.concat(b))); } alert("Import sikeres."); loadStats(); loadMiniStats(); } catch(err){ alert("Import hiba: "+err.message); } }; reader.readAsText(f); ev.target.value=''; }

/* Helpers */
function formatDate(ts){ if(!ts) return ""; try{ const d=new Date(ts); return d.toLocaleString('hu-HU',{year:'numeric',month:'short',day:'numeric',hour:'2-digit',minute:'2-digit'}); }catch(e){return "";} }
function truncate(str,max){ if(!str) return ""; return str.length>max?str.slice(0,max-1)+'‚Ä¶':str; }
function escapeHtml(s){ if(!s) return ''; return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;').replace(/'/g,'&#39;'); }

document.addEventListener('DOMContentLoaded', ()=>{
  initDOM();
  createMiniChart(); // egyszer hozzuk l√©tre ‚Äî √≠gy nem okoz layout mozg√°st
  newQuote();
  countJournalChars();
  loadMiniStats();
  if(document.getElementById('stat').classList.contains('active')) loadStats();
});
</script>
</body>
</html>
