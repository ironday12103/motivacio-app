<!DOCTYPE html>
<html lang="hu">
<head>
<meta charset="UTF-8" />
<title>Motiv√°ci√≥ App</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0" />

<link rel="manifest" href="manifest.json">
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
/* Alap st√≠lusok */
body{margin:0;background:#000;color:#fff;font-family:Arial,Helvetica,sans-serif;display:flex;justify-content:center;align-items:center;height:100vh}
.app{width:100%;max-width:480px;height:96vh;background:#111;border-radius:28px;padding:18px;box-shadow:0 0 40px rgba(0,0,0,.9);overflow:auto;position:relative}
.tabs{display:flex;gap:6px;margin-bottom:10px}
.tabs button{flex:1;border:none;border-radius:14px;padding:10px;background:#333;color:#fff;font-size:13px;cursor:pointer}
.tabs button.active{background:#ff9800;color:#000}
.view{display:none}.view.active{display:block}

/* F≈ëoldali st√≠lusok */
.header-quote{text-align:center;font-size:14px;margin-bottom:8px;opacity:.9}
.motivation-card{background:linear-gradient(135deg,#ff9800,#ff5722,#9c27b0);border-radius:22px;padding:14px;text-align:center}
.author-photo{width:120px;height:120px;border-radius:50%;object-fit:cover;margin:8px auto 10px auto;border:3px solid rgba(255,255,255,0.12);background:#222;display:block;cursor:pointer}
#authorTag{display:inline-block;padding:6px 14px;border-radius:16px;font-weight:bold;background:#222;color:#ff9800;margin-bottom:6px}
#authorCredit{display:block;font-size:11px;opacity:0.85;margin-top:6px;color:#ddd}
#authorCredit a{color:#ffd89b;text-decoration:underline}
.big-quote{font-size:24px;font-weight:bold;line-height:1.2}

/* Goals */
.goals-panel{margin-top:12px;display:block}
.goals-tabs{display:flex;gap:8px;margin-bottom:8px}
.goals-tabs button{flex:1;padding:8px;border-radius:10px;border:none;background:#333;color:#fff;cursor:pointer}
.goals-tabs button.active{background:#ff9800;color:#000}
.goal-inputs{display:flex;gap:8px;margin-bottom:8px}
.goal-inputs input{flex:1;padding:8px;border-radius:10px;border:none}
.goal-list{display:flex;flex-direction:column;gap:8px;margin-top:6px}
.goal-item{background:#1c1c1c;padding:8px;border-radius:12px;display:flex;gap:8px;align-items:center}
.goal-item .text{flex:1}
.goal-actions{display:flex;gap:6px}
.small-icon{background:#333;border-radius:8px;padding:6px;color:#fff;border:none;cursor:pointer}

/* Diagram (popover) */
.diagram-popover-backdrop{position:fixed;left:0;top:0;right:0;bottom:0;background:rgba(0,0,0,0.6);display:flex;align-items:center;justify-content:center;z-index:5000;display:none}
.diagram-popover{background:#111;border-radius:12px;padding:12px;width:94%;max-width:520px;box-shadow:0 8px 40px rgba(0,0,0,0.7)}
.popover-header{display:flex;justify-content:space-between;align-items:center;gap:8px}
.popover-tabs{display:flex;gap:6px;margin-top:8px}
.popover-tabs button{padding:8px;border-radius:8px;border:none;background:#333;color:#fff;cursor:pointer}
.popover-tabs button.active{background:#ff9800;color:#000}
.popover-body{margin-top:8px}
.popover-chart{height:220px}
.fav-list{max-height:260px;overflow:auto;margin-top:8px}

/* Menu controls */
.menu-controls{display:flex;gap:8px;margin-bottom:8px}
.menu-controls button{flex:1;padding:10px;border-radius:10px;border:none;background:#333;color:#fff;cursor:pointer}
.menu-controls button.active{background:#ff9800;color:#000}

/* Account view */
.account-card{background:#1d1d1d;padding:12px;border-radius:12px}
.account-row{display:flex;justify-content:space-between;gap:8px;align-items:center}
.account-row b{font-size:14px}

/* Shared */
textarea,input,select{width:100%;padding:12px;border-radius:14px;border:none;margin-top:8px;box-sizing:border-box}
input[type=range]{width:100%;margin-top:8px}
button{width:100%;padding:12px;border:none;border-radius:14px;margin-top:8px;cursor:pointer}
.main{background:#ff9800;color:#000}
.secondary{background:#333;color:#fff}
.card{background:#1d1d1d;border-radius:16px;padding:12px;margin-bottom:8px}
.stat-box{background:#222;border-radius:16px;padding:12px;margin-bottom:8px}
.entry-meta{font-size:12px;opacity:.85;margin-top:6px}
.entry-actions{margin-top:8px;display:flex;gap:6px}
.small-btn{flex:1;padding:8px;border-radius:10px;font-size:13px}
.small-danger{background:#b00020;color:#fff}
.small-secondary{background:#333;color:#fff}

/* Modal / Undo / IO */
.modal-backdrop{position:fixed;left:0;top:0;right:0;bottom:0;background:rgba(0,0,0,0.6);display:flex;align-items:center;justify-content:center;z-index:2000}
.modal{background:#111;border-radius:12px;padding:16px;width:92%;max-width:420px;box-shadow:0 8px 24px rgba(0,0,0,0.6)}
.modal header{font-weight:bold;margin-bottom:8px}
.modal .row{margin-top:8px}
.modal .actions{display:flex;gap:8px;margin-top:12px}
.modal .actions button{flex:1}
#undoBar{position:fixed;left:50%;transform:translateX(-50%);bottom:18px;background:#222;color:#fff;padding:10px 12px;border-radius:12px;display:flex;gap:8px;align-items:center;z-index:3000;box-shadow:0 8px 20px rgba(0,0,0,0.6);display:none}
.io-actions{display:flex;gap:8px;margin-top:8px;flex-wrap:wrap}
.io-actions button{flex:1;padding:10px;border-radius:10px}
.file-input{display:none}

/* three-dot button */
.more-btn{position:fixed;right:22px;top:22px;width:44px;height:44px;border-radius:50%;background:#222;color:#fff;border:2px solid rgba(255,255,255,0.04);display:flex;align-items:center;justify-content:center;z-index:4000;cursor:pointer}
.more-btn:hover{background:#2a2a2a}
</style>
</head>
<body>
<div class="app">

  <div class="tabs">
    <button class="tab-btn active" data-target="mot">üî•</button>
    <button class="tab-btn" data-target="nap">üìì</button>
    <button class="tab-btn" data-target="sport">üèãÔ∏è</button>
    <button class="tab-btn" data-target="book">üìö</button>
    <button class="tab-btn" data-target="stat">üìä</button>
    <button class="tab-btn" data-target="menu">‚ò∞</button>
  </div>

  <div class="header-quote" id="dailyQuote"></div>

  <!-- F≈êOLDAL: csak egy k√©p (szerz≈ë portr√©) √©s id√©zet + c√©lok -->
  <div id="mot" class="view active">
    <div class="motivation-card">
      <img id="authorPhoto" class="author-photo" alt="Szerz≈ë k√©pe" title="Kattints a forr√°s megnyit√°s√°hoz, ha el√©rhet≈ë">
      <div id="authorTag"></div>
      <div id="authorCredit"></div>
      <div class="big-quote" id="quote"></div>
    </div>
    <button id="newQuoteBtn" class="main">√öj motiv√°ci√≥</button>

    <!-- Goals: k√∂zeli / t√°voli -->
    <div class="goals-panel card" id="goalsPanel">
      <div style="font-weight:bold;margin-bottom:8px">C√©lok</div>
      <div class="goals-tabs">
        <button id="nearTab" class="active">K√∂zeli c√©lok</button>
        <button id="farTab">T√°voli c√©lok</button>
      </div>
      <div class="goal-inputs">
        <input id="goalText" placeholder="√öj c√©l megad√°sa..." />
        <select id="goalPriority">
          <option value="normal">Norm√°l</option>
          <option value="high">Fontos</option>
        </select>
        <button id="addGoalBtn" class="small-icon">+</button>
      </div>
      <div style="font-size:12px;opacity:.85">Mindk√©t kateg√≥ria szerkeszthet≈ë, t√∂r√∂lhet≈ë √©s pip√°lhat√≥.</div>
      <div class="goal-list" id="goalList"></div>
    </div>

  </div>

  <!-- NAPL√ì -->
  <div id="nap" class="view">
    <textarea id="journal" placeholder="√çrd le a napod..." rows="6"></textarea>
    <div class="card">Karakterek: <b><span id="charCount">0</span> / 90</b></div>
    <button class="secondary" id="saveJournalBtn" disabled>Ment√©s</button>
  </div>

  <!-- SPORT -->
  <div id="sport" class="view">
    <label>Edz√©s t√≠pusa</label>
    <select id="stype">
      <option>Fut√°s</option>
      <option>S√∫lyz√≥s</option>
      <option>Ker√©kp√°r</option>
      <option>√ösz√°s</option>
      <option>J√≥ga</option>
      <option>Egy√©b</option>
    </select>
    <label>Id≈ëtartam (perc): <span id="sportDurationLabel">30</span> min</label>
    <input id="sportDuration" type="range" min="5" max="240" value="30">
    <button class="secondary" id="saveSportBtn">Ment√©s</button>
  </div>

  <!-- K√ñNYV -->
  <div id="book" class="view">
    <input id="btitle" placeholder="K√∂nyv c√≠me">
    <label>Oldalsz√°m ma: <span id="bookPagesLabel">20</span> oldal</label>
    <input id="bpages" type="range" min="0" max="2000" value="20">
    <label>Olvas√°s ideje ma (perc): <input id="bminutes" type="number" min="0" max="1440" value="0" style="width:110px;display:inline-block;margin-left:8px"></label>
    <button class="secondary" id="saveBookBtn">Ment√©s</button>
  </div>

  <!-- STAT (r√©szletes) -->
  <div id="stat" class="view">
    <div class="stat-tabs">
      <button id="weekBtn" class="active">Heti</button>
      <button id="yearBtn">√âves</button>
    </div>

    <canvas id="statChart"></canvas>

    <div class="stat-box" id="statWrite"></div>
    <div class="stat-box" id="statSport"></div>
    <div class="stat-box" id="statBook"></div>

    <div class="card"><b>Napl√≥k</b><div id="statJournalList"></div></div>
    <div class="card"><b>Edz√©sek</b><div id="statSportList"></div></div>
    <div class="card"><b>K√∂nyvek</b><div id="statBookList"></div></div>

    <div class="card">
      <b>Adatok (Export / Import)</b>
      <div class="io-actions">
        <button id="exportBtn" class="secondary">Export√°l√°s JSON</button>
        <button id="importBtn" class="secondary">Import√°l√°s JSON</button>
        <input id="fileInput" class="file-input" type="file" accept="application/json">
      </div>
    </div>
  </div>

  <!-- MEN√ú: Fi√≥k (diagram elt√°vol√≠tva innen; a diagram a jobb fels≈ë "..." men√ºben tal√°lhat√≥) -->
  <div id="menu" class="view">
    <div class="menu-controls">
      <button id="accountBtn" class="active">Fi√≥k</button>
    </div>

    <div id="accountView" style="display:block; margin-top:12px;">
      <div class="account-card">
        <div class="account-row"><b>N√©v</b><div id="accName">‚Äî</div></div>
        <div class="account-row" style="margin-top:8px;"><b>E-mail</b><div id="accEmail">‚Äî</div></div>
        <div style="margin-top:10px;display:flex;gap:8px;">
          <button id="editAccountBtn" class="secondary">Szerkeszt</button>
          <button id="clearAccountBtn" class="small-btn small-danger" style="width:auto">T√∂r√∂l</button>
        </div>
      </div>
    </div>

  </div>

</div>

<!-- Modal -->
<div id="modalBackdrop" class="modal-backdrop" style="display:none">
  <div class="modal" role="dialog" aria-modal="true" aria-labelledby="modalTitle">
    <header id="modalTitle">Szerkeszt√©s</header>
    <div id="modalBody">
      <div class="row" id="modalFieldJournal" style="display:none">
        <label for="modalJournal">Napl√≥</label>
        <textarea id="modalJournal" rows="6"></textarea>
        <div class="card">Karakterek: <b><span id="modalCharCount">0</span> / 90</b></div>
      </div>
      <div class="row" id="modalFieldSport" style="display:none">
        <label for="modalSportType">Edz√©s t√≠pus</label>
        <input id="modalSportType" />
        <label>Id≈ëtartam (perc): <span id="modalSportDurationLabel">30</span></label>
        <input id="modalSportDuration" type="range" min="5" max="240" value="30">
      </div>
      <div class="row" id="modalFieldBook" style="display:none">
        <label for="modalBookTitle">K√∂nyv c√≠me</label>
        <input id="modalBookTitle" />
        <label>Oldalsz√°m: <span id="modalBookPagesLabel">20</span></label>
        <input id="modalBookPages" type="range" min="0" max="2000" value="20">
        <label>Olvas√°s (perc): <input id="modalBookMinutes" type="number" min="0" max="1440" value="0" style="width:110px;display:inline-block;margin-left:8px"></label>
      </div>
      <div class="row" id="modalFieldGoal" style="display:none">
        <label for="modalGoalText">C√©l</label>
        <input id="modalGoalText" />
        <label for="modalGoalCategory">Kateg√≥ria</label>
        <select id="modalGoalCategory"><option value="near">K√∂zeli</option><option value="far">T√°voli</option></select>
        <label><input id="modalGoalDone" type="checkbox"> K√©sz</label>
      </div>
    </div>
    <div class="actions">
      <button id="modalSaveBtn" class="main">Ment√©s</button>
      <button id="modalCancelBtn" class="secondary">M√©gse</button>
    </div>
  </div>
</div>

<!-- Diagram / Favorites popover (opened by three-dot button) -->
<div id="diagramPopoverBackdrop" class="diagram-popover-backdrop">
  <div class="diagram-popover">
    <div class="popover-header">
      <strong id="popoverTitle">Diagramok</strong>
      <button id="closePopover" class="small-icon">‚úï</button>
    </div>

    <div style="margin-top:8px;display:flex;gap:8px;align-items:center">
      <div style="flex:1">
        <div class="popover-tabs">
          <button id="popDiagramBtn" class="active">Teljes√≠tm√©ny</button>
          <button id="popFavBtn">Kedvencek</button>
        </div>
      </div>
      <div style="width:180px;display:flex;gap:6px;">
        <button id="popMonthBtn" class="popover-mode active">Havi</button>
        <button id="popYearBtn" class="popover-mode">√âvi</button>
      </div>
    </div>

    <div class="popover-body">
      <div id="popoverDiagramArea">
        <div class="popover-chart">
          <canvas id="popoverDiagramChart"></canvas>
        </div>
        <div id="popoverDiagramText" style="margin-top:8px;color:#ddd;font-size:13px"></div>
      </div>

      <div id="popoverFavArea" style="display:none">
        <div style="display:flex;gap:8px;margin-bottom:8px">
          <button id="favAddQuote" class="secondary" style="flex:1">Aktu√°lis id√©zet ment√©se</button>
          <button id="favClearAll" class="small-danger" style="width:120px">√ñsszes t√∂rl√©se</button>
        </div>
        <div class="fav-list card" id="favList"></div>
      </div>
    </div>
  </div>
</div>

<!-- Undo bar -->
<div id="undoBar">
  <span id="undoMsg">Bejegyz√©s t√∂r√∂lve</span>
  <button id="undoBtn" class="main">Vissza√°ll√≠t</button>
  <button id="undoDismiss" class="secondary">Bez√°r</button>
</div>

<!-- three-dot more button -->
<button class="more-btn" id="moreBtn" title="Tov√°bbi men√º">‚ãØ</button>

<script>
/*
  B≈ëv√≠t√©sek:
  1) F≈ëoldalon (mot) C√©lok panel: K√∂zeli / T√°voli kateg√≥ri√°k, szerkeszt√©s, t√∂rl√©s, pip√°l√°s (k√©sz).
  2) A diagram kiker√ºlt a Menub√≥l: a jobb fels≈ë h√°rom pont men√ºben van egy popover, ott a diagram √©s a Kedvencek.
     A diagramn√°l havi √©s √©vi n√©zet v√°laszthat√≥ (havi: utols√≥ 12 h√≥nap; √©vi: utols√≥ 5 √©v).
  3) K√∂nyv: visszahozva oldal-s√°v (slider) √©s napi olvas√°si percek (sz√°mmez≈ë).
  4) Edz√©s: visszahozott cs√∫szka az id≈ëtartamra, t√∂bb kateg√≥ria.
  5) Kedvencek: a popoverban list√°zhat√≥k, menthet≈ëk √©s t√∂r√∂lhet≈ëk kedvenc id√©zetek/edz√©sek/k√∂nyvek.
  Fontos: az alap m≈±k√∂d√©s maradt √©s a megl√©v≈ë adatok tov√°bbra is localStorage-ban t√°rol√≥dnak.
*/

const quotes = [
 {a:"David Goggins", t:"A f√°jdalom ideiglenes.", p:""},
 {a:"Elon Musk", t:"Ha fontos, megcsin√°lod.", p:""},
 {a:"Steve Jobs", t:"Az √©letedet az hat√°rozza meg, amit teszel, nem az, amit mondasz.", p:"https://upload.wikimedia.org/wikipedia/commons/6/6c/Steve_Jobs_Headshot_2010-CROP.jpg", credit:"Matthew Yohe / CC BY-SA 3.0", creditUrl:"https://en.wikipedia.org/wiki/File:Steve_Jobs_Headshot_2010-CROP.jpg"},
 {a:"Nelson Mandela", t:"Mindig √∫gy t≈±nik lehetetlennek, am√≠g meg nem csin√°lod.", p:""},
 {a:"Winston Churchill", t:"Soha ne add fel.", p:""},
 {a:"Confucius", t:"A legt√°volabbi utaz√°s is egy l√©p√©ssel kezd≈ëdik.", p:""},
 {a:"Eleanor Roosevelt", t:"Ne f√©lj megpr√≥b√°lni.", p:""},
 {a:"Albert Einstein", t:"Pr√≥b√°lj meg mindig jobb lenni.", p:""},
 {a:"Mark Twain", t:"Az oda√©r√©s titka az, hogy elindulsz.", p:""},
 {a:"Henry Ford", t:"Ha azt hiszed, hogy k√©pes vagy r√°, m√°r f√©lig k√©sz vagy.", p:""}
];

let statMode = "week";
let statChartObj = null;
let diagramChartObj = null; // kor√°bbi diagram
let popDiagramObj = null; // popover diagram
const DOM = {};
let undoStack = [];
let undoTimeouts = [];
let currentEdit = null;

// --- INIT DOM ---
function initDOM(){
  DOM.authorPhoto = document.getElementById('authorPhoto');
  DOM.authorTag = document.getElementById('authorTag');
  DOM.authorCredit = document.getElementById('authorCredit');
  DOM.quote = document.getElementById('quote');
  DOM.dailyQuote = document.getElementById('dailyQuote');

  DOM.journal = document.getElementById('journal');
  DOM.charCount = document.getElementById('charCount');
  DOM.saveJournalBtn = document.getElementById('saveJournalBtn');

  DOM.stype = document.getElementById('stype');
  DOM.saveSportBtn = document.getElementById('saveSportBtn');
  DOM.sportDuration = document.getElementById('sportDuration');
  DOM.sportDurationLabel = document.getElementById('sportDurationLabel');

  DOM.btitle = document.getElementById('btitle');
  DOM.saveBookBtn = document.getElementById('saveBookBtn');
  DOM.bpages = document.getElementById('bpages');
  DOM.bookPagesLabel = document.getElementById('bookPagesLabel');
  DOM.bminutes = document.getElementById('bminutes');

  DOM.weekBtn = document.getElementById('weekBtn');
  DOM.yearBtn = document.getElementById('yearBtn');

  DOM.statWrite = document.getElementById('statWrite');
  DOM.statSport = document.getElementById('statSport');
  DOM.statBook = document.getElementById('statBook');

  DOM.statJournalList = document.getElementById('statJournalList');
  DOM.statSportList = document.getElementById('statSportList');
  DOM.statBookList = document.getElementById('statBookList');

  DOM.statChart = document.getElementById('statChart');

  DOM.diagramBtn = document.getElementById('diagramBtn');
  DOM.accountBtn = document.getElementById('accountBtn');
  DOM.diagramView = document.getElementById('diagramView');
  DOM.accountView = document.getElementById('accountView');

  DOM.accName = document.getElementById('accName');
  DOM.accEmail = document.getElementById('accEmail');
  DOM.editAccountBtn = document.getElementById('editAccountBtn');
  DOM.clearAccountBtn = document.getElementById('clearAccountBtn');

  DOM.modalBackdrop = document.getElementById('modalBackdrop');
  DOM.modalJournal = document.getElementById('modalJournal');
  DOM.modalCharCount = document.getElementById('modalCharCount');
  DOM.modalFieldJournal = document.getElementById('modalFieldJournal');
  DOM.modalFieldSport = document.getElementById('modalFieldSport');
  DOM.modalSportType = document.getElementById('modalSportType');
  DOM.modalSportDuration = document.getElementById('modalSportDuration');
  DOM.modalSportDurationLabel = document.getElementById('modalSportDurationLabel');
  DOM.modalFieldBook = document.getElementById('modalFieldBook');
  DOM.modalBookTitle = document.getElementById('modalBookTitle');
  DOM.modalBookPages = document.getElementById('modalBookPages');
  DOM.modalBookPagesLabel = document.getElementById('modalBookPagesLabel');
  DOM.modalBookMinutes = document.getElementById('modalBookMinutes');
  DOM.modalFieldGoal = document.getElementById('modalFieldGoal');
  DOM.modalGoalText = document.getElementById('modalGoalText');
  DOM.modalGoalCategory = document.getElementById('modalGoalCategory');
  DOM.modalGoalDone = document.getElementById('modalGoalDone');

  DOM.modalSaveBtn = document.getElementById('modalSaveBtn');
  DOM.modalCancelBtn = document.getElementById('modalCancelBtn');

  DOM.undoBar = document.getElementById('undoBar');
  DOM.undoBtn = document.getElementById('undoBtn');
  DOM.undoDismiss = document.getElementById('undoDismiss');
  DOM.undoMsg = document.getElementById('undoMsg');

  DOM.exportBtn = document.getElementById('exportBtn');
  DOM.importBtn = document.getElementById('importBtn');
  DOM.fileInput = document.getElementById('fileInput');

  DOM.moreBtn = document.getElementById('moreBtn');
  DOM.diagramPopoverBackdrop = document.getElementById('diagramPopoverBackdrop');
  DOM.popDiagramChart = document.getElementById('popoverDiagramChart');
  DOM.popDiagramText = document.getElementById('popoverDiagramText');
  DOM.popDiagramArea = document.getElementById('popoverDiagramArea');
  DOM.popFavArea = document.getElementById('popoverFavArea');
  DOM.popFavList = document.getElementById('favList');
  DOM.popDiagramBtn = document.getElementById('popDiagramBtn');
  DOM.popFavBtn = document.getElementById('popFavBtn');
  DOM.popMonthBtn = document.getElementById('popMonthBtn');
  DOM.popYearBtn = document.getElementById('popYearBtn');
  DOM.favAddQuote = document.getElementById('favAddQuote');
  DOM.favClearAll = document.getElementById('favClearAll');

  DOM.goalsPanel = document.getElementById('goalsPanel');
  DOM.nearTab = document.getElementById('nearTab');
  DOM.farTab = document.getElementById('farTab');
  DOM.goalText = document.getElementById('goalText');
  DOM.goalPriority = document.getElementById('goalPriority');
  DOM.addGoalBtn = document.getElementById('addGoalBtn');
  DOM.goalList = document.getElementById('goalList');

  document.querySelectorAll('.tab-btn').forEach(btn=>{
    btn.addEventListener('click', ()=> {
      document.querySelectorAll('.tab-btn').forEach(b=>b.classList.remove('active'));
      btn.classList.add('active');
      const id = btn.dataset.target;
      const scrollTop = document.scrollingElement ? document.scrollingElement.scrollTop : window.pageYOffset;
      document.querySelectorAll('.view').forEach(v=>v.classList.remove('active'));
      const tgt = document.getElementById(id);
      if(tgt) tgt.classList.add('active');
      setTimeout(()=> {
        if(document.scrollingElement) document.scrollingElement.scrollTop = scrollTop;
        else window.scrollTo(0, scrollTop);
      }, 0);
      if(id === 'stat') setTimeout(loadStats,200);
    });
  });

  document.getElementById('newQuoteBtn').addEventListener('click', newQuote);

  if(DOM.accountBtn) DOM.accountBtn.addEventListener('click', ()=> { DOM.accountBtn.classList.add('active'); DOM.accountView.style.display='block'; loadAccountInfo(); });

  if (DOM.saveJournalBtn) DOM.saveJournalBtn.addEventListener('click', saveJournal);
  if (DOM.saveSportBtn) DOM.saveSportBtn.addEventListener('click', saveSport);
  if (DOM.saveBookBtn) DOM.saveBookBtn.addEventListener('click', saveBook);

  if (DOM.weekBtn) DOM.weekBtn.addEventListener('click', ()=> switchStat('week'));
  if (DOM.yearBtn) DOM.yearBtn.addEventListener('click', ()=> switchStat('year'));

  if (DOM.journal) DOM.journal.addEventListener('input', countJournalChars);

  if (DOM.authorPhoto) DOM.authorPhoto.addEventListener('click', ()=>{
    const current = DOM.authorPhoto.dataset.sourceUrl;
    if(current) window.open(current,'_blank','noopener');
  });

  if(DOM.authorPhoto){
    DOM.authorPhoto.addEventListener('error', ()=>{
      DOM.authorPhoto.src = 'data:image/svg+xml;utf8,'+encodeURIComponent('<svg xmlns="http://www.w3.org/2000/svg" width="120" height="120"><rect width="100%" height="100%" fill="#222"/><circle cx="60" cy="40" r="28" fill="#ff9800"/><rect x="20" y="80" width="80" height="12" fill="#444"/></svg>');
    });
  }

  [DOM.statJournalList, DOM.statSportList, DOM.statBookList].forEach(listEl=>{
    if(!listEl) return;
    listEl.addEventListener('click', ev=>{
      const btn = ev.target.closest('button[data-action]');
      if(!btn) return;
      const action = btn.dataset.action;
      const type = btn.dataset.type;
      const idx = parseInt(btn.dataset.idx,10);
      if(action === 'edit') openEditModal(type, idx);
      if(action === 'delete') performDelete(type, idx);
      if(action === 'fav') toggleFavoriteFromList(type, idx);
    });
  });

  if (DOM.modalSaveBtn) DOM.modalSaveBtn.addEventListener('click', modalSave);
  if (DOM.modalCancelBtn) DOM.modalCancelBtn.addEventListener('click', closeModal);
  if (DOM.modalJournal) DOM.modalJournal.addEventListener('input', ()=> DOM.modalCharCount.innerText = DOM.modalJournal.value.length);
  if (DOM.modalSportDuration) DOM.modalSportDuration.addEventListener('input', ()=> DOM.modalSportDurationLabel.innerText = DOM.modalSportDuration.value);
  if (DOM.modalBookPages) DOM.modalBookPages.addEventListener('input', ()=> DOM.modalBookPagesLabel.innerText = DOM.modalBookPages.value);

  if (DOM.undoBtn) DOM.undoBtn.addEventListener('click', undoLast);
  if (DOM.undoDismiss) DOM.undoDismiss.addEventListener('click', hideUndoBar);

  if (DOM.exportBtn) DOM.exportBtn.addEventListener('click', exportData);
  if (DOM.importBtn) DOM.importBtn.addEventListener('click', ()=> DOM.fileInput.click());
  if (DOM.fileInput) DOM.fileInput.addEventListener('change', importFile);

  if (DOM.editAccountBtn) DOM.editAccountBtn.addEventListener('click', openAccountEditor);
  if (DOM.clearAccountBtn) DOM.clearAccountBtn.addEventListener('click', clearAccount);

  if (DOM.sportDuration) { DOM.sportDuration.addEventListener('input', ()=> DOM.sportDurationLabel.innerText = DOM.sportDuration.value); }
  if (DOM.bpages) { DOM.bpages.addEventListener('input', ()=> DOM.bookPagesLabel.innerText = DOM.bpages.value); }

  // Popover / more button
  if (DOM.moreBtn) DOM.moreBtn.addEventListener('click', ()=> { DOM.diagramPopoverBackdrop.style.display='flex'; ensurePopoverChart(); refreshFavoritesList(); });
  document.getElementById('closePopover').addEventListener('click', ()=> DOM.diagramPopoverBackdrop.style.display='none');
  if (DOM.popDiagramBtn) DOM.popDiagramBtn.addEventListener('click', ()=> { DOM.popDiagramBtn.classList.add('active'); DOM.popFavBtn.classList.remove('active'); DOM.popDiagramArea.style.display='block'; DOM.popFavArea.style.display='none'; ensurePopoverChart(); });
  if (DOM.popFavBtn) DOM.popFavBtn.addEventListener('click', ()=> { DOM.popFavBtn.classList.add('active'); DOM.popDiagramBtn.classList.remove('active'); DOM.popDiagramArea.style.display='none'; DOM.popFavArea.style.display='block'; refreshFavoritesList(); });
  if (DOM.popMonthBtn) DOM.popMonthBtn.addEventListener('click', ()=> { DOM.popMonthBtn.classList.add('active'); DOM.popYearBtn.classList.remove('active'); ensurePopoverChart('month'); });
  if (DOM.popYearBtn) DOM.popYearBtn.addEventListener('click', ()=> { DOM.popYearBtn.classList.add('active'); DOM.popMonthBtn.classList.remove('active'); ensurePopoverChart('year'); });
  if (DOM.favAddQuote) DOM.favAddQuote.addEventListener('click', addCurrentQuoteToFavorites);
  if (DOM.favClearAll) DOM.favClearAll.addEventListener('click', ()=> { if(confirm("Biztosan t√∂rl√∂d az √∂sszes kedvencet?")){ localStorage.removeItem('favorites'); refreshFavoritesList(); alert('T√∂r√∂lve.'); } });

  // Goals
  if (DOM.nearTab) DOM.nearTab.addEventListener('click', ()=> switchGoalTab('near'));
  if (DOM.farTab) DOM.farTab.addEventListener('click', ()=> switchGoalTab('far'));
  if (DOM.addGoalBtn) DOM.addGoalBtn.addEventListener('click', addGoal);
  DOM.goalList.addEventListener('click', ev=>{
    const btn = ev.target.closest('button[data-action]');
    if(!btn) return;
    const action = btn.dataset.action;
    const idx = parseInt(btn.dataset.idx,10);
    if(action==='edit') openEditModal('goal', idx);
    if(action==='delete') performDelete('goal', idx);
    if(action==='toggle') toggleGoalDone(idx);
  });
}

// --- GOALS ---
let activeGoalTab = 'near';
function switchGoalTab(k){ activeGoalTab=k; DOM.nearTab.classList.toggle('active',k==='near'); DOM.farTab.classList.toggle('active',k==='far'); renderGoals(); }
function getGoals(){ return JSON.parse(localStorage.getItem('goals')||"[]"); }
function saveGoals(g){ localStorage.setItem('goals', JSON.stringify(g)); }
function addGoal(){
  const text = (DOM.goalText.value||'').trim();
  if(!text) return alert('Adj meg egy c√©lt.');
  const cat = (activeGoalTab==='near') ? 'near' : 'far';
  const pr = DOM.goalPriority.value||'normal';
  const g = getGoals();
  g.push({text,category:cat,priority:pr,done:false,date:Date.now()});
  saveGoals(g);
  DOM.goalText.value='';
  renderGoals();
}
function renderGoals(){
  const g = getGoals().map((x,i)=>({...x,_idx:i}));
  const filtered = g.filter(x=>x.category===activeGoalTab);
  DOM.goalList.innerHTML = filtered.map(x=>`<div class="goal-item">
    <button class="small-icon" data-action="toggle" data-idx="${x._idx}" title="K√©sz / nem k√©sz">${x.done? '‚òë' : '‚ñ¢'}</button>
    <div class="text">${escapeHtml(x.text)}${x.priority==='high' ? ' <small style="color:#ffd89b">‚Ä¢ fontoss√°g</small>':''}</div>
    <div class="goal-actions">
      <button class="small-icon" data-action="edit" data-idx="${x._idx}">‚úé</button>
      <button class="small-icon" data-action="delete" data-idx="${x._idx}">üóë</button>
    </div>
  </div>`).join('');
}
function toggleGoalDone(idx){
  const g = getGoals();
  if(idx<0||idx>=g.length) return;
  g[idx].done = !g[idx].done;
  saveGoals(g);
  renderGoals();
}

// --- POPOVER DIAGRAM (havi/√©vi aggreg√°l√°s) ---
function ensurePopoverChart(mode='month'){
  // mode: 'month' (12 months) or 'year' (5 years)
  const j = JSON.parse(localStorage.getItem('journal')||"[]");
  const s = JSON.parse(localStorage.getItem('sport')||"[]");
  const b = JSON.parse(localStorage.getItem('book')||"[]");
  const now = new Date();
  let labels=[], jdata=[], sdata=[], bdata=[];
  if(mode==='month'){
    // last 12 months, label 'Mon' translated short months
    const months = [];
    for(let i=11;i>=0;i--){
      const d = new Date(now.getFullYear(), now.getMonth()-i, 1);
      months.push({y:d.getFullYear(), m:d.getMonth()});
    }
    labels = months.map(x=>new Date(x.y, x.m,1).toLocaleString('hu-HU',{month:'short'}));
    jdata = months.map(m => j.filter(z=>{ const d=new Date(z.date); return d.getFullYear()===m.y && d.getMonth()===m.m }).length);
    sdata = months.map(m => s.filter(z=>{ const d=new Date(z.date); return d.getFullYear()===m.y && d.getMonth()===m.m }).length);
    bdata = months.map(m => b.filter(z=>{ const d=new Date(z.date); return d.getFullYear()===m.y && d.getMonth()===m.m }).length);
  } else {
    // last 5 years
    const years=[];
    for(let i=4;i>=0;i--){
      const y = now.getFullYear()-i;
      years.push(y);
    }
    labels = years.map(y=>String(y));
    jdata = years.map(y=> j.filter(z=> new Date(z.date).getFullYear()===y).length);
    sdata = years.map(y=> s.filter(z=> new Date(z.date).getFullYear()===y).length);
    bdata = years.map(y=> b.filter(z=> new Date(z.date).getFullYear()===y).length);
  }

  if(popDiagramObj) popDiagramObj.destroy();
  const ctx = DOM.popDiagramChart.getContext('2d');
  popDiagramObj = new Chart(ctx, {
    type:'bar',
    data: { labels, datasets:[
      { label:'Napl√≥', data:jdata, backgroundColor:'#ff9800'},
      { label:'Edz√©s', data:sdata, backgroundColor:'#ff5722'},
      { label:'K√∂nyv', data:bdata, backgroundColor:'#9c27b0'}
    ]},
    options:{responsive:true,maintainAspectRatio:false,animation:false,scales:{y:{beginAtZero:true}},plugins:{legend:{position:'bottom',labels:{color:'#ddd'}}}}
  });

  DOM.popDiagramText.innerText = `Napl√≥k: ${j.length} ‚Äî Edz√©sek: ${s.length} ‚Äî K√∂nyvek: ${b.length}`;
}

// --- FAVORITES ---
function getFavorites(){ return JSON.parse(localStorage.getItem('favorites')||"[]"); }
function saveFavorites(arr){ localStorage.setItem('favorites', JSON.stringify(arr)); }
function addCurrentQuoteToFavorites(){
  const txt = DOM.quote ? DOM.quote.innerText : '';
  const author = DOM.authorTag ? DOM.authorTag.innerText : '';
  if(!txt) return alert('Nincs aktu√°lis id√©zet.');
  const fav = getFavorites();
  fav.push({kind:'quote',date:Date.now(),payload:{text:txt,author}});
  saveFavorites(fav);
  refreshFavoritesList();
  alert('Id√©zet elmentve a kedvencek k√∂z√©.');
}
function refreshFavoritesList(){
  const fav = getFavorites().map((x,i)=>({...x,_idx:i}));
  DOM.popFavList.innerHTML = fav.length===0 ? '<div style="opacity:.8">Nincsenek mentett kedvencek.</div>' : fav.map(x=>{
    if(x.kind==='quote') return `<div style="display:flex;gap:8px;align-items:flex-start;padding:8px;border-radius:8px;background:#111;margin-bottom:8px">
      <div style="flex:1"><div style="font-weight:bold">${escapeHtml(x.payload.text)}</div><div style="font-size:12px;opacity:.8">${escapeHtml(x.payload.author||'')}</div></div>
      <div style="display:flex;flex-direction:column;gap:6px">
        <button class="small-icon" data-fav-action="delete" data-idx="${x._idx}">üóë</button>
      </div>
    </div>`;
    if(x.kind==='sport') return `<div style="display:flex;gap:8px;align-items:flex-start;padding:8px;border-radius:8px;background:#111;margin-bottom:8px">
      <div style="flex:1"><div style="font-weight:bold">${escapeHtml(x.payload.type)} ‚Äî ${x.payload.duration} perc</div><div style="font-size:12px;opacity:.8">${formatDate(x.date)}</div></div>
      <div style="display:flex;flex-direction:column;gap:6px">
        <button class="small-icon" data-fav-action="delete" data-idx="${x._idx}">üóë</button>
      </div>
    </div>`;
    if(x.kind==='book') return `<div style="display:flex;gap:8px;align-items:flex-start;padding:8px;border-radius:8px;background:#111;margin-bottom:8px">
      <div style="flex:1"><div style="font-weight:bold">${escapeHtml(x.payload.title)} ‚Äî ${x.payload.pages} oldal</div><div style="font-size:12px;opacity:.8">${formatDate(x.date)}</div></div>
      <div style="display:flex;flex-direction:column;gap:6px">
        <button class="small-icon" data-fav-action="delete" data-idx="${x._idx}">üóë</button>
      </div>
    </div>`;
    return '';
  }).join('');

  DOM.popFavList.querySelectorAll('button[data-fav-action]').forEach(btn=>{
    btn.addEventListener('click', ev=>{
      const idx = parseInt(btn.dataset.idx,10);
      const arr = getFavorites();
      arr.splice(idx,1);
      saveFavorites(arr);
      refreshFavoritesList();
    });
  });
}

// allow favoriting from stat lists
function toggleFavoriteFromList(type, idx){
  if(typeof idx !== 'number' || isNaN(idx)) return;
  const arr = JSON.parse(localStorage.getItem(type)||"[]");
  const item = arr[idx];
  if(!item) return;
  const fav = getFavorites();
  if(type==='sport') fav.push({kind:'sport',date:Date.now(),payload:{type:item.type,duration:item.duration || item.time || 0}});
  if(type==='book') fav.push({kind:'book',date:Date.now(),payload:{title:item.title,pages:item.pages||item.pagesCount||0}});
  if(type==='journal') fav.push({kind:'quote',date:Date.now(),payload:{text:item.text,author:''}});
  saveFavorites(fav);
  alert('Hozz√°adva a kedvencekhez.');
  refreshFavoritesList();
}

// --- CRUD alapok (kiterjesztve sport/book modal mez≈ëkkel) ---
function countJournalChars(){ if(!DOM.charCount||!DOM.journal||!DOM.saveJournalBtn) return; const len=DOM.journal.value.length; DOM.charCount.innerText=len; DOM.saveJournalBtn.disabled = len<90; }
function saveJournal(){ if(!DOM.journal) return; const text=DOM.journal.value.trim(); if(text.length<90){alert("A napl√≥nak legal√°bb 90 karakter hossz√∫nak kell lennie.");return} let j=JSON.parse(localStorage.getItem('journal')||"[]"); j.push({text:text,date:Date.now()}); localStorage.setItem('journal',JSON.stringify(j)); DOM.journal.value=""; countJournalChars(); if(document.getElementById('stat').classList.contains('active')) loadStats(); ensurePopoverChart(); renderGoals(); }
function saveSport(){ if(!DOM.stype) return; const type=DOM.stype.value?DOM.stype.value.trim():""; const duration = parseInt(DOM.sportDuration.value,10) || 0; if(!type){alert("Adj meg egy edz√©s t√≠pust.");return} let s=JSON.parse(localStorage.getItem('sport')||"[]"); s.push({type:type,duration:duration,date:Date.now()}); localStorage.setItem('sport',JSON.stringify(s)); if(document.getElementById('stat').classList.contains('active')) loadStats(); ensurePopoverChart(); }
function saveBook(){ if(!DOM.btitle) return; const title=DOM.btitle.value?DOM.btitle.value.trim():""; const pages = parseInt(DOM.bpages.value,10)||0; const minutes = parseInt(DOM.bminutes.value,10)||0; if(!title){alert("Adj meg egy k√∂nyvc√≠met.");return} let b=JSON.parse(localStorage.getItem('book')||"[]"); b.push({title:title,pages:pages,minutes:minutes,date:Date.now()}); localStorage.setItem('book',JSON.stringify(b)); DOM.btitle.value=""; DOM.bpages.value=20; DOM.bminutes.value=0; DOM.bookPagesLabel.innerText='20'; if(document.getElementById('stat').classList.contains('active')) loadStats(); ensurePopoverChart(); }

// stat load: extended display of pages/duration info
function switchStat(m){ statMode=m; if(DOM.weekBtn) DOM.weekBtn.classList.toggle("active", m==="week"); if(DOM.yearBtn) DOM.yearBtn.classList.toggle("active", m==="year"); loadStats(); }
function loadStats(){
  const now=Date.now(), week=7*864e5;
  const j=JSON.parse(localStorage.getItem('journal')||"[]");
  const s=JSON.parse(localStorage.getItem('sport')||"[]");
  const b=JSON.parse(localStorage.getItem('book')||"[]");
  const jWithIdx=j.map((x,i)=>({...x,_idx:i}));
  const sWithIdx=s.map((x,i)=>({...x,_idx:i}));
  const bWithIdx=b.map((x,i)=>({...x,_idx:i}));
  const jf = statMode==="week" ? jWithIdx.filter(x=>now-x.date<week) : jWithIdx;
  const sf = statMode==="week" ? sWithIdx.filter(x=>now-x.date<week) : sWithIdx;
  const bf = statMode==="week" ? bWithIdx.filter(x=>now-x.date<week) : bWithIdx;
  if(DOM.statWrite) DOM.statWrite.innerText = `üìì Napl√≥k: ${jf.length}`;
  if(DOM.statSport) DOM.statSport.innerText = `üèãÔ∏è Edz√©sek: ${sf.length} ‚Äî √ñssz id≈ë: ${sf.reduce((a,c)=>a+(c.duration||0),0)} perc`;
  if(DOM.statBook) DOM.statBook.innerText = `üìö K√∂nyvek: ${bf.length} ‚Äî √ñssz oldalak: ${bf.reduce((a,c)=>a+(c.pages||0),0)}`;

  if(statChartObj) statChartObj.destroy();
  if(DOM.statChart){
    statChartObj = new Chart(DOM.statChart, { type:"bar", data:{labels:["Napl√≥","Edz√©s","K√∂nyv"],datasets:[{data:[jf.length,sf.length,bf.length],backgroundColor:['#ff9800','#ff5722','#9c27b0']}]}, options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{display:false}},scales:{y:{beginAtZero:true}}} });
  }

  if(document.getElementById('statJournalList')) document.getElementById('statJournalList').innerHTML = jf.map(x=>`<div class="card">${escapeHtml(truncate(x.text,200))}<div class="entry-meta">${formatDate(x.date)}</div><div class="entry-actions"><button class="small-btn small-secondary" data-action="edit" data-type="journal" data-idx="${x._idx}">Szerkeszt</button><button class="small-btn small-danger" data-action="delete" data-type="journal" data-idx="${x._idx}">T√∂r√∂l</button><button class="small-btn small-secondary" data-action="fav" data-type="journal" data-idx="${x._idx}">Kedvenc</button></div></div>`).join("");
  if(document.getElementById('statSportList')) document.getElementById('statSportList').innerHTML = sf.map(x=>`<div class="card">${escapeHtml(x.type)} ‚Äî ${x.duration||0} perc<div class="entry-meta">${formatDate(x.date)}</div><div class="entry-actions"><button class="small-btn small-secondary" data-action="edit" data-type="sport" data-idx="${x._idx}">Szerkeszt</button><button class="small-btn small-danger" data-action="delete" data-type="sport" data-idx="${x._idx}">T√∂r√∂l</button><button class="small-btn small-secondary" data-action="fav" data-type="sport" data-idx="${x._idx}">Kedvenc</button></div></div>`).join("");
  if(document.getElementById('statBookList')) document.getElementById('statBookList').innerHTML = bf.map(x=>`<div class="card">${escapeHtml(x.title)} ‚Äî ${x.pages||0} oldal (${x.minutes||0} perc)<div class="entry-meta">${formatDate(x.date)}</div><div class="entry-actions"><button class="small-btn small-secondary" data-action="edit" data-type="book" data-idx="${x._idx}">Szerkeszt</button><button class="small-btn small-danger" data-action="delete" data-type="book" data-idx="${x._idx}">T√∂r√∂l</button><button class="small-btn small-secondary" data-action="fav" data-type="book" data-idx="${x._idx}">Kedvenc</button></div></div>`).join("");
}

// --- Account ---
function loadAccountInfo(){ const acc=JSON.parse(localStorage.getItem('account')||"{}"); if(DOM.accName) DOM.accName.innerText=acc.name||'‚Äî'; if(DOM.accEmail) DOM.accEmail.innerText=acc.email||'‚Äî'; }
function openAccountEditor(){ const acc=JSON.parse(localStorage.getItem('account')||"{}"); const name=prompt("N√©v:", acc.name||""); if(name===null) return; const email=prompt("E-mail:", acc.email||""); if(email===null) return; localStorage.setItem('account',JSON.stringify({name:name.trim(),email:email.trim()})); loadAccountInfo(); }
function clearAccount(){ if(!confirm("Biztosan t√∂rl√∂d a fi√≥kadatokat?")) return; localStorage.removeItem('account'); loadAccountInfo(); }

// --- Modal / edit / delete / undo / import/export (kiterjesztve goal/sport/book) ---
function openEditModal(type, originalIdx){
  currentEdit={type,idx:originalIdx};
  DOM.modalFieldJournal.style.display='none';
  DOM.modalFieldSport.style.display='none';
  DOM.modalFieldBook.style.display='none';
  DOM.modalFieldGoal.style.display='none';
  const arr = JSON.parse(localStorage.getItem(type)||"[]");
  const item = arr[originalIdx] || {};
  if(type==='journal'){ DOM.modalFieldJournal.style.display=''; DOM.modalJournal.value=item.text||''; DOM.modalCharCount.innerText = DOM.modalJournal.value.length; }
  if(type==='sport'){ DOM.modalFieldSport.style.display=''; DOM.modalSportType.value = item.type || ''; DOM.modalSportDuration.value = item.duration || 30; DOM.modalSportDurationLabel.innerText = DOM.modalSportDuration.value; }
  if(type==='book'){ DOM.modalFieldBook.style.display=''; DOM.modalBookTitle.value = item.title || ''; DOM.modalBookPages.value = item.pages || 20; DOM.modalBookPagesLabel.innerText = DOM.modalBookPages.value; DOM.modalBookMinutes.value = item.minutes || 0; }
  if(type==='goal'){ DOM.modalFieldGoal.style.display=''; DOM.modalGoalText.value = item.text || ''; DOM.modalGoalCategory.value = item.category || 'near'; DOM.modalGoalDone.checked = !!item.done; }
  DOM.modalBackdrop.style.display='flex';
  setTimeout(()=>{ if(type==='journal') DOM.modalJournal.focus(); if(type==='sport') DOM.modalSportType.focus(); if(type==='book') DOM.modalBookTitle.focus(); if(type==='goal') DOM.modalGoalText.focus(); },50);
}
function closeModal(){ currentEdit=null; DOM.modalBackdrop.style.display='none'; }
function modalSave(){
  if(!currentEdit) return;
  const {type,idx} = currentEdit;
  let arr = JSON.parse(localStorage.getItem(type)||"[]");
  if(type==='journal'){
    const newText = DOM.modalJournal.value.trim();
    if(newText.length<90){ alert("A napl√≥nak legal√°bb 90 karakter hossz√∫nak kell lennie."); return; }
    if(idx>=0 && idx<arr.length){ arr[idx].text=newText; arr[idx].date=Date.now(); } else arr.push({text:newText,date:Date.now()});
  } else if(type==='sport'){
    const newType = DOM.modalSportType.value.trim();
    const dur = parseInt(DOM.modalSportDuration.value,10) || 0;
    if(!newType){ alert("Adj meg egy edz√©s t√≠pust."); return; }
    if(idx>=0 && idx<arr.length){ arr[idx].type=newType; arr[idx].duration=dur; arr[idx].date=Date.now(); } else arr.push({type:newType,duration:dur,date:Date.now()});
  } else if(type==='book'){
    const newTitle = DOM.modalBookTitle.value.trim();
    const pages = parseInt(DOM.modalBookPages.value,10)||0;
    const mins = parseInt(DOM.modalBookMinutes.value,10)||0;
    if(!newTitle){ alert("Adj meg egy k√∂nyvc√≠met."); return; }
    if(idx>=0 && idx<arr.length){ arr[idx].title=newTitle; arr[idx].pages=pages; arr[idx].minutes=mins; arr[idx].date=Date.now(); } else arr.push({title:newTitle,pages:pages,minutes:mins,date:Date.now()});
  } else if(type==='goal'){
    const text = DOM.modalGoalText.value.trim();
    const cat = DOM.modalGoalCategory.value || 'near';
    const done = !!DOM.modalGoalDone.checked;
    if(!text){ alert('Adj meg egy c√©lt.'); return; }
    if(idx>=0 && idx<arr.length){ arr[idx].text=text; arr[idx].category=cat; arr[idx].done=done; arr[idx].date=Date.now(); } else arr.push({text,category:cat,done:done,priority:'normal',date:Date.now()});
  }
  localStorage.setItem(type, JSON.stringify(arr));
  closeModal();
  loadStats();
  ensurePopoverChart();
  renderGoals();
}
function performDelete(type, originalIdx){
  let arr = JSON.parse(localStorage.getItem(type)||"[]");
  if(originalIdx<0||originalIdx>=arr.length) return;
  const [removed] = arr.splice(originalIdx,1);
  localStorage.setItem(type, JSON.stringify(arr));
  const undoEntry = {type, data:removed, idx:originalIdx};
  undoStack.push(undoEntry);
  if(DOM.undoMsg) DOM.undoMsg.innerText = `T√∂r√∂lve: ${truncate(removed.text||removed.type||removed.title||'',40)}`;
  if(DOM.undoBar) DOM.undoBar.style.display='flex';
  loadStats();
  ensurePopoverChart();
  renderGoals();
  const to = setTimeout(()=>{ const pos = undoStack.indexOf(undoEntry); if(pos>=0) undoStack.splice(pos,1); if(undoStack.length===0 && DOM.undoBar) DOM.undoBar.style.display='none'; },8000);
  undoTimeouts.push(to);
}
function undoLast(){
  if(undoStack.length===0) return;
  const entry = undoStack.pop();
  const t = undoTimeouts.pop();
  if(t) clearTimeout(t);
  let arr = JSON.parse(localStorage.getItem(entry.type)||"[]");
  const insertIdx = Math.min(Math.max(0,entry.idx),arr.length);
  arr.splice(insertIdx,0,entry.data);
  localStorage.setItem(entry.type,JSON.stringify(arr));
  loadStats();
  ensurePopoverChart();
  if(undoStack.length===0 && DOM.undoBar) DOM.undoBar.style.display='none';
}
function hideUndoBar(){ undoStack=[]; undoTimeouts.forEach(t=>clearTimeout(t)); undoTimeouts=[]; if(DOM.undoBar) DOM.undoBar.style.display='none'; }

// --- Import / Export ---
function exportData(){ const payload={journal:JSON.parse(localStorage.getItem('journal')||"[]"),sport:JSON.parse(localStorage.getItem('sport')||"[]"),book:JSON.parse(localStorage.getItem('book')||"[]"),goals:JSON.parse(localStorage.getItem('goals')||"[]"),favorites:JSON.parse(localStorage.getItem('favorites')||"[]"),exportedAt:Date.now()}; const blob=new Blob([JSON.stringify(payload,null,2)],{type:'application/json'}); const url=URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download=`motivacio-export-${new Date().toISOString().slice(0,10)}.json`; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url); }
function importFile(ev){ const f=ev.target.files&&ev.target.files[0]; if(!f) return; const reader=new FileReader(); reader.onload=function(e){ try{ const data=JSON.parse(e.target.result); if(typeof data!=='object') throw new Error('Hib√°s f√°jl.'); const j=Array.isArray(data.journal)?data.journal:[]; const s=Array.isArray(data.sport)?data.sport:[]; const b=Array.isArray(data.book)?data.book:[]; const g=Array.isArray(data.goals)?data.goals:[]; const fav=Array.isArray(data.favorites)?data.favorites:[]; const wantReplace=confirm("Fel√ºl√≠rja a helyi adatokat az import√°ltakkal? (OK = fel√ºl√≠r, M√©gse = √∂sszevon√°s)"); if(wantReplace){ localStorage.setItem('journal',JSON.stringify(j)); localStorage.setItem('sport',JSON.stringify(s)); localStorage.setItem('book',JSON.stringify(b)); localStorage.setItem('goals',JSON.stringify(g)); localStorage.setItem('favorites',JSON.stringify(fav)); } else { const curJ=JSON.parse(localStorage.getItem('journal')||"[]"); const curS=JSON.parse(localStorage.getItem('sport')||"[]"); const curB=JSON.parse(localStorage.getItem('book')||"[]"); const curG=JSON.parse(localStorage.getItem('goals')||"[]"); const curF=JSON.parse(localStorage.getItem('favorites')||"[]"); localStorage.setItem('journal',JSON.stringify(curJ.concat(j))); localStorage.setItem('sport',JSON.stringify(curS.concat(s))); localStorage.setItem('book',JSON.stringify(curB.concat(b))); localStorage.setItem('goals',JSON.stringify(curG.concat(g))); localStorage.setItem('favorites',JSON.stringify(curF.concat(fav))); } alert("Import sikeres."); loadStats(); ensurePopoverChart(); renderGoals(); } catch(err){ alert("Import hiba: "+err.message); } }; reader.readAsText(f); ev.target.value=''; }

// --- Helpers ---
function formatDate(ts){ if(!ts) return ""; try{ const d=new Date(ts); return d.toLocaleString('hu-HU',{year:'numeric',month:'short',day:'numeric',hour:'2-digit',minute:'2-digit'}); }catch(e){return "";} }
function truncate(str,max){ if(!str) return ""; return str.length>max?str.slice(0,max-1)+'‚Ä¶':str; }
function escapeHtml(s){ if(s===undefined || s===null) return ''; return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;').replace(/'/g,'&#39;'); }

// --- Inicializ√°l√°s √©s kezdeti be√°ll√≠t√°sok ---
document.addEventListener('DOMContentLoaded', ()=>{
  initDOM();
  newQuote();
  countJournalChars();
  renderGoals();
  // ha a felhaszn√°l√≥ k√∂zvetlen√ºl a men√ºt hagyta akt√≠vnak, nincs diagram ott ‚Äî a h√°rom pont men√ºben jelenik meg
  if(document.getElementById('stat').classList.contains('active')) loadStats();
});

// --- Quote √∫jrat√∂lt√©s ---
function newQuote(){
  const q = quotes[Math.floor(Math.random()*quotes.length)];
  if(DOM.quote) DOM.quote.innerText = q.t;
  const avatar = q.p ? q.p : ('https://i.pravatar.cc/150?u=' + encodeURIComponent(q.a));
  if(DOM.authorPhoto){ DOM.authorPhoto.src = avatar; DOM.authorPhoto.alt = q.a; DOM.authorPhoto.dataset.sourceUrl = q.creditUrl || ''; }
  if(DOM.authorTag) DOM.authorTag.innerText = q.a;
  if(DOM.authorCredit){ if(q.credit) DOM.authorCredit.innerHTML = `<a href="${escapeHtml(q.creditUrl||'#')}" target="_blank" rel="noopener noreferrer">${escapeHtml(q.credit)}</a>`; else DOM.authorCredit.innerHTML = ''; }
  if(DOM.dailyQuote) DOM.dailyQuote.innerText = q.t + " ‚Äì " + q.a;
  // ha a popover nyitva van √©s diagram n√©zet akt√≠v, friss√≠ts√ºk
  if(DOM.diagramPopoverBackdrop && DOM.diagramPopoverBackdrop.style.display==='flex' && DOM.popDiagramArea && DOM.popDiagramArea.style.display!=='none'){
    ensurePopoverChart(DOM.popMonthBtn && DOM.popMonthBtn.classList.contains('active') ? 'month' : 'year');
  }
}

// --- Bizonyos alap view-ok friss√≠t√©se ---
function ensureDiagramCreatedAndUpdated(){
  // kor√°bbi funkci√≥t fenntartjuk de diagram a popoverben l√°that√≥ ‚Äî √≠gy ide csak statikus friss√≠t√©st ind√≠tunk
  ensurePopoverChart();
}

// --- Tov√°bbi seg√©dfunkci√≥k √©s visszajelz√©s a UI-ra ---
// (nincs tov√°bbi k√≥d)
</script>
</body>
</html>
