<!DOCTYPE html>
<html lang="hu">
<head>
<meta charset="UTF-8">
<title>Motiv√°ci√≥ App</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<link rel="manifest" href="manifest.json">
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
/* Alap st√≠lusok */
body{
 margin:0;
 background:#000;
 color:#fff;
 font-family:Arial,Helvetica,sans-serif;
 display:flex;
 justify-content:center;
 align-items:center;
 height:100vh;
}
.app{
 width:100%;
 max-width:480px;
 height:96vh;
 background:#111;
 border-radius:28px;
 padding:18px;
 box-shadow:0 0 40px rgba(0,0,0,.9);
 overflow:auto;
 position:relative;
}
.tabs{
 display:flex;
 gap:6px;
 margin-bottom:10px;
}
.tabs button{
 flex:1;
 border:none;
 border-radius:14px;
 padding:10px;
 background:#333;
 color:#fff;
 font-size:13px;
 cursor:pointer;
}
.tabs button.active{
 background:#ff9800;
 color:#000;
}
.view{display:none;}
.view.active{display:block;}

.stat-tabs{
 display:flex;
 gap:6px;
 margin-bottom:10px;
}
.stat-tabs button{
 flex:1;
 border:none;
 border-radius:14px;
 padding:10px;
 background:#333;
 color:#fff;
 cursor:pointer;
}
.stat-tabs button.active{
 background:#ff9800;
 color:#000;
}

#statChart{
 width:100%;
 height:240px;
 display:block;
}

.header-quote{text-align:center;font-size:14px;margin-bottom:8px;opacity:.9;}

.motivation-card{
 background:linear-gradient(135deg,#ff9800,#ff5722,#9c27b0);
 border-radius:22px;
 padding:14px;
 text-align:center;
}
.motivation-card img{
 width:100%;
 height:40vh;
 max-height:320px;
 object-fit:cover;
 border-radius:16px;
}

/* Szerz≈ëi fot√≥ (kis, k√∂r alak√∫ k√©p a motiv√°ci√≥s sz√∂veg el≈ëtt) */
.author-photo{
 width:96px;
 height:96px;
 border-radius:50%;
 object-fit:cover;
 margin:10px auto 6px auto;
 border:3px solid rgba(255,255,255,0.12);
 background:#222;
 display:block;
}

#authorTag{
 display:inline-block;
 padding:6px 14px;
 border-radius:16px;
 font-weight:bold;
 background:#222;
 color:#ff9800;
 margin-bottom:6px;
}
#authorCredit{
 display:block;
 font-size:11px;
 opacity:0.85;
 margin-top:6px;
 color:#ddd;
}
#authorCredit a{ color:#ffd89b; text-decoration:underline; }

.big-quote{font-size:24px;font-weight:bold;}

textarea,input,select{
 width:100%;
 padding:12px;
 border-radius:14px;
 border:none;
 margin-top:8px;
 box-sizing:border-box;
}

button{
 width:100%;
 padding:12px;
 border:none;
 border-radius:14px;
 margin-top:8px;
 cursor:pointer;
}
.main{background:#ff9800;color:#000;}
.secondary{background:#333;color:#fff;}

.card{background:#1d1d1d;border-radius:16px;padding:12px;margin-bottom:8px;}
.stat-box{background:#222;border-radius:16px;padding:12px;margin-bottom:8px;}

.entry-meta{font-size:12px;opacity:.85;margin-top:6px;}
.entry-actions{margin-top:8px;display:flex;gap:6px;}
.small-btn{flex:1;padding:8px;border-radius:10px;font-size:13px;}
.small-danger{background:#b00020;color:#fff;}
.small-secondary{background:#333;color:#fff;}

/* Modal st√≠lusok */
.modal-backdrop{
 position:fixed;
 left:0;top:0;right:0;bottom:0;
 background:rgba(0,0,0,0.6);
 display:flex;
 align-items:center;
 justify-content:center;
 z-index:2000;
}
.modal{
 background:#111;
 border-radius:12px;
 padding:16px;
 width:92%;
 max-width:420px;
 box-shadow:0 8px 24px rgba(0,0,0,0.6);
}
.modal header{font-weight:bold;margin-bottom:8px;}
.modal .row{margin-top:8px;}
.modal .actions{display:flex;gap:8px;margin-top:12px;}
.modal .actions button{flex:1}

/* Undo bar */
#undoBar{
 position:fixed;
 left:50%;
 transform:translateX(-50%);
 bottom:18px;
 background:#222;
 color:#fff;
 padding:10px 12px;
 border-radius:12px;
 display:flex;
 gap:8px;
 align-items:center;
 z-index:3000;
 box-shadow:0 8px 20px rgba(0,0,0,0.6);
 display:none;
}
#undoBar button{width:auto;padding:8px 10px;border-radius:10px}

/* Export/Import area */
.io-actions{display:flex;gap:8px;margin-top:8px;flex-wrap:wrap;}
.io-actions button{flex:1;padding:10px;border-radius:10px}
.file-input{display:none}
</style>
</head>

<body>
<div class="app">

<div class="tabs">
 <button class="tab-btn active" data-target="mot">üî•</button>
 <button class="tab-btn" data-target="nap">üìì</button>
 <button class="tab-btn" data-target="sport">üèãÔ∏è</button>
 <button class="tab-btn" data-target="book">üìö</button>
 <button class="tab-btn" data-target="stat">üìä</button>
</div>

<div class="header-quote" id="dailyQuote"></div>

<div id="mot" class="view active">
 <div class="motivation-card">
  <img id="motImg" alt="Motiv√°ci√≥s k√©p">
  <!-- Szerz≈ëi fot√≥ a motiv√°ci√≥s sz√∂veg f√∂l√∂tt -->
  <img id="authorPhoto" class="author-photo" alt="Szerz≈ë k√©pe">
  <div id="authorTag"></div>
  <div id="authorCredit"></div>
  <div class="big-quote" id="quote"></div>
 </div>
 <button id="newQuoteBtn" class="main">√öj motiv√°ci√≥</button>
</div>

<div id="nap" class="view">
 <textarea id="journal" placeholder="√çrd le a napod..." rows="6"></textarea>
 <div class="card">Karakterek: <b><span id="charCount">0</span> / 90</b></div>
 <button class="secondary" id="saveJournalBtn" disabled>Ment√©s</button>
</div>

<div id="sport" class="view">
 <select id="stype"><option>Fut√°s</option><option>S√∫lyz√≥s</option></select>
 <button class="secondary" id="saveSportBtn">Ment√©s</button>
</div>

<div id="book" class="view">
 <input id="btitle" placeholder="K√∂nyv c√≠me">
 <button class="secondary" id="saveBookBtn">Ment√©s</button>
</div>

<div id="stat" class="view">
 <div class="stat-tabs">
  <button id="weekBtn" class="active">Heti</button>
  <button id="yearBtn">√âves</button>
 </div>

 <canvas id="statChart"></canvas>

 <div class="stat-box" id="statWrite"></div>
 <div class="stat-box" id="statSport"></div>
 <div class="stat-box" id="statBook"></div>

 <div class="card">
  <b>Napl√≥k</b>
  <div id="statJournalList"></div>
 </div>
 <div class="card">
  <b>Edz√©sek</b>
  <div id="statSportList"></div>
 </div>
 <div class="card">
  <b>K√∂nyvek</b>
  <div id="statBookList"></div>
 </div>

 <div class="card">
  <b>Adatok (Export / Import)</b>
  <div class="io-actions">
   <button id="exportBtn" class="secondary">Export√°l√°s JSON</button>
   <button id="importBtn" class="secondary">Import√°l√°s JSON</button>
   <input id="fileInput" class="file-input" type="file" accept="application/json">
  </div>
 </div>
</div>

</div>

<!-- Modal (rejtett) -->
<div id="modalBackdrop" class="modal-backdrop" style="display:none">
 <div class="modal" role="dialog" aria-modal="true" aria-labelledby="modalTitle">
  <header id="modalTitle">Szerkeszt√©s</header>
  <div id="modalBody">
   <!-- Dinamikus tartalom -->
   <div class="row" id="modalFieldJournal" style="display:none">
    <label for="modalJournal">Napl√≥</label>
    <textarea id="modalJournal" rows="6"></textarea>
    <div class="card">Karakterek: <b><span id="modalCharCount">0</span> / 90</b></div>
   </div>

   <div class="row" id="modalFieldSport" style="display:none">
    <label for="modalSportType">Edz√©s t√≠pus</label>
    <input id="modalSportType" />
   </div>

   <div class="row" id="modalFieldBook" style="display:none">
    <label for="modalBookTitle">K√∂nyv c√≠me</label>
    <input id="modalBookTitle" />
   </div>
  </div>

  <div class="actions">
   <button id="modalSaveBtn" class="main">Ment√©s</button>
   <button id="modalCancelBtn" class="secondary">M√©gse</button>
  </div>
 </div>
</div>

<!-- Undo bar -->
<div id="undoBar">
 <span id="undoMsg">Bejegyz√©s t√∂r√∂lve</span>
 <button id="undoBtn" class="main">Vissza√°ll√≠t</button>
 <button id="undoDismiss" class="secondary">Bez√°r</button>
</div>

<script>
/*
  Automatikus avatar (pravatar) minden id√©z≈ën√©l:
  - ha a quote-ban nincs kifejezetten k√©p URL, akkor a pravatarot haszn√°ljuk a szerz≈ë neve alapj√°n
  - nincs sz√ºks√©g egyedi p mez≈ëkre
  - meg≈ëriz minden kor√°bbi funkci√≥t (modal, undo, export/import, stat)
*/

const quotes = [
 {a:"David Goggins", t:"A f√°jdalom ideiglenes.", i:"https://picsum.photos/800/400?random=1"},
 {a:"Elon Musk", t:"Ha fontos, megcsin√°lod.", i:"https://picsum.photos/800/400?random=2"},
 {a:"Steve Jobs", t:"Az √©letedet az hat√°rozza meg, amit teszel, nem az, amit mondasz.", i:"https://picsum.photos/800/400?random=3"},
 {a:"Nelson Mandela", t:"Mindig √∫gy t≈±nik lehetetlennek, am√≠g meg nem csin√°lod.", i:"https://picsum.photos/800/400?random=4"},
 {a:"Winston Churchill", t:"Soha ne add fel.", i:"https://picsum.photos/800/400?random=5"},
 {a:"Confucius", t:"A legt√°volabbi utaz√°s is egy l√©p√©ssel kezd≈ëdik.", i:"https://picsum.photos/800/400?random=6"},
 {a:"Eleanor Roosevelt", t:"Ne f√©lj megpr√≥b√°lni.", i:"https://picsum.photos/800/400?random=7"},
 {a:"Steve Jobs (id√©zet 2)", t:"Maradj √©hes, maradj bolond.", i:"https://picsum.photos/800/400?random=8"},
 {a:"Albert Einstein", t:"Pr√≥b√°lj meg mindig jobb lenni.", i:"https://picsum.photos/800/400?random=9"},
 {a:"Mark Twain", t:"Az oda√©r√©s titka az, hogy elindulsz.", i:"https://picsum.photos/800/400?random=10"},
 {a:"Henry Ford", t:"Ha azt hiszed, hogy k√©pes vagy r√°, m√°r f√©lig k√©sz vagy.", i:"https://picsum.photos/800/400?random=11"},
 {a:"Mahatma Gandhi", t:"Legy√©l te a v√°ltoz√°s, amit l√°tni szeretn√©l a vil√°gban.", i:"https://picsum.photos/800/400?random=12"},
 {a:"Bruce Lee", t:"Ne legyenek korl√°taid, csak c√©ljaid.", i:"https://picsum.photos/800/400?random=13"},
 {a:"Theodore Roosevelt", t:"Sok ember kudarcot vall, mert elt√∂k√©lt√©k, hogy keveset fognak tenni.", i:"https://picsum.photos/800/400?random=14"},
 {a:"Vince Lombardi", t:"A gy≈ëzelem nem minden, de a gy≈ëzni akar√°s igen.", i:"https://picsum.photos/800/400?random=15"},
 {a:"Oprah Winfrey", t:"A legnagyobb kaland az, hogy megtal√°ld val√≥di √∂nmagad.", i:"https://picsum.photos/800/400?random=16"},
 {a:"Les Brown", t:"C√©ljaid hat√°rozz√°k meg j√∂v≈ëdet.", i:"https://picsum.photos/800/400?random=17"},
 {a:"Jim Rohn", t:"A siker nem v√©letlen, hanem szok√°sok eredm√©nye.", i:"https://picsum.photos/800/400?random=18"},
 {a:"Tony Robbins", t:"A cselekv√©s a kulcs minden sikerhez.", i:"https://picsum.photos/800/400?random=19"},
 {a:"Buddha", t:"Minden pillanat egy √∫j kezdet lehet.", i:"https://picsum.photos/800/400?random=20"},
 {a:"Paulo Coelho", t:"Az √©let mindig ad m√°sodik es√©lyt: h√≠vj√°k ma napnak.", i:"https://picsum.photos/800/400?random=21"},
 {a:"J. K. Rowling", t:"A kudarcok a siker alapanyagai.", i:"https://picsum.photos/800/400?random=22"},
 {a:"Michael Jordan", t:"Aki feladja, soha nem fogja megtudni.", i:"https://picsum.photos/800/400?random=23"},
 {a:"Soren Kierkegaard", t:"Az √©letet h√°trafel√© kell meg√©rteni, de el≈ërefel√© √©lni.", i:"https://picsum.photos/800/400?random=24"},
 {a:"Amelia Earhart", t:"A lehet≈ës√©geid hat√°rozz√°k meg j√∂v≈ëdet, ne f√©ld ≈ëket haszn√°lni.", i:"https://picsum.photos/800/400?random=25"},
 {a:"Arnold Schwarzenegger", t:"√Ålmodj nagyot, dolgozz kem√©nyen.", i:"https://picsum.photos/800/400?random=26"},
 {a:"Ralph Waldo Emerson", t:"A b√°tors√°g nem a f√©lelem hi√°nya, hanem tettek a f√©lelem ellen√©re.", i:"https://picsum.photos/800/400?random=27"},
 {a:"Helen Keller", t:"A legnagyobb h√°tr√°nyod lehet a legnagyobb er≈ëforr√°sod.", i:"https://picsum.photos/800/400?random=28"},
 {a:"Simon Sinek", t:"Kezdd azzal, hogy mi√©rt.", i:"https://picsum.photos/800/400?random=29"},
 {a:"Brene Brown", t:"A sebezhet≈ës√©g a b√°tors√°g forr√°sa.", i:"https://picsum.photos/800/400?random=30"},
 {a:"Dale Carnegie", t:"√úgyelj arra, hogyan besz√©lsz magaddal‚Äîaz hat√°rozza meg tetteidet.", i:"https://picsum.photos/800/400?random=31"},
 {a:"John Wooden", t:"A siker az, amikor minden nap a legjobbat adod.", i:"https://picsum.photos/800/400?random=32"},
 {a:"Zig Ziglar", t:"A gondolkod√°sod hat√°rozza meg j√∂v≈ëdet.", i:"https://picsum.photos/800/400?random=33"},
 {a:"Marcus Aurelius", t:"Az akad√°ly maga az √∫t.", i:"https://picsum.photos/800/400?random=34"},
 {a:"Seneca", t:"Nem az az ember szerencs√©s, aki mindent megkap, hanem aki el√©gedett.", i:"https://picsum.photos/800/400?random=35"},
 {a:"Rumi", t:"A v√°ltoz√°s dallam√°t csak akkor hallod, ha mozogsz.", i:"https://picsum.photos/800/400?random=36"},
 {a:"Kurt Vonnegut", t:"Az √©let nem arr√≥l sz√≥l, hogy v√°rjuk a vihart, hanem hogy t√°ncoljunk az es≈ëben.", i:"https://picsum.photos/800/400?random=37"},
 {a:"Florence Nightingale", t:"A kis dolgok ism√©tl≈ëd√©se hozza a nagy v√°ltoz√°st.", i:"https://picsum.photos/800/400?random=38"},
 {a:"Robert Frost", t:"Az √∫t, amelyet v√°lasztasz, hat√°rozza meg √©leted.", i:"https://picsum.photos/800/400?random=39"},
 {a:"Ayn Rand", t:"Az ember c√©lja a boldogs√°g ‚Äì dolgozz √©rte.", i:"https://picsum.photos/800/400?random=40"},
 {a:"Mary Anne Radmacher", t:"L√©gy b√°tor. L√©gy √∂nmagad.", i:"https://picsum.photos/800/400?random=41"},
 {a:"Barbara Corcoran", t:"A sikerhez kock√°ztatni kell.", i:"https://picsum.photos/800/400?random=42"},
 {a:"Bill Gates", t:"Tanulj mindig, a tud√°s hozza a lehet≈ës√©get.", i:"https://picsum.photos/800/400?random=43"},
 {a:"Jeff Bezos", t:"Kezdd kicsiben, gondolkodj nagyban.", i:"https://picsum.photos/800/400?random=44"},
 {a:"Sheryl Sandberg", t:"√Ållj fel √©s pr√≥b√°lkozz √∫jra.", i:"https://picsum.photos/800/400?random=45"},
 {a:"Larry Page", t:"Ne f√©lj nagyot √°lmodni.", i:"https://picsum.photos/800/400?random=46"},
 {a:"Malala Yousafzai", t:"Egy k√∂nyv √©s egy toll megv√°ltoztathatja a vil√°got.", i:"https://picsum.photos/800/400?random=47"},
 {a:"Simon Bolivar", t:"A b√°tors√°g hirdeti a szabads√°got.", i:"https://picsum.photos/800/400?random=48"},
 {a:"Unknown", t:"Minden nagy √∫t egyetlen l√©p√©ssel kezd≈ëdik.", i:"https://picsum.photos/800/400?random=49"},
 {a:"Unknown", t:"T≈±zz ki c√©lt, dolgozz √©rte, soha ne add fel.", i:"https://picsum.photos/800/400?random=50"}
];

let statMode = "week";
let statChartObj = null;
const DOM = {};
let undoStack = []; // t√∂mb az utols√≥ t√∂rl√©sek sz√°m√°ra
let undoTimeouts = []; // t√°rolja a setTimeout ID-ket a cleanuphez
let currentEdit = null; // {type:'journal'|'sport'|'book', idx: originalIndex}

/* Init DOM √©s eventek */
function initDOM(){
 DOM.quote = document.getElementById('quote');
 DOM.motImg = document.getElementById('motImg');
 DOM.authorPhoto = document.getElementById('authorPhoto');
 DOM.authorTag = document.getElementById('authorTag');
 DOM.authorCredit = document.getElementById('authorCredit');
 DOM.dailyQuote = document.getElementById('dailyQuote');

 DOM.journal = document.getElementById('journal');
 DOM.charCount = document.getElementById('charCount');
 DOM.saveJournalBtn = document.getElementById('saveJournalBtn');

 DOM.stype = document.getElementById('stype');
 DOM.saveSportBtn = document.getElementById('saveSportBtn');

 DOM.btitle = document.getElementById('btitle');
 DOM.saveBookBtn = document.getElementById('saveBookBtn');

 DOM.weekBtn = document.getElementById('weekBtn');
 DOM.yearBtn = document.getElementById('yearBtn');

 DOM.statWrite = document.getElementById('statWrite');
 DOM.statSport = document.getElementById('statSport');
 DOM.statBook = document.getElementById('statBook');

 DOM.statJournalList = document.getElementById('statJournalList');
 DOM.statSportList = document.getElementById('statSportList');
 DOM.statBookList = document.getElementById('statBookList');

 DOM.statChart = document.getElementById('statChart');

 // Modal elemek
 DOM.modalBackdrop = document.getElementById('modalBackdrop');
 DOM.modalJournal = document.getElementById('modalJournal');
 DOM.modalCharCount = document.getElementById('modalCharCount');
 DOM.modalFieldJournal = document.getElementById('modalFieldJournal');
 DOM.modalFieldSport = document.getElementById('modalFieldSport');
 DOM.modalSportType = document.getElementById('modalSportType');
 DOM.modalFieldBook = document.getElementById('modalFieldBook');
 DOM.modalBookTitle = document.getElementById('modalBookTitle');
 DOM.modalSaveBtn = document.getElementById('modalSaveBtn');
 DOM.modalCancelBtn = document.getElementById('modalCancelBtn');

 // Undo
 DOM.undoBar = document.getElementById('undoBar');
 DOM.undoBtn = document.getElementById('undoBtn');
 DOM.undoDismiss = document.getElementById('undoDismiss');
 DOM.undoMsg = document.getElementById('undoMsg');

 // IO
 DOM.exportBtn = document.getElementById('exportBtn');
 DOM.importBtn = document.getElementById('importBtn');
 DOM.fileInput = document.getElementById('fileInput');

 // Tabs
 document.querySelectorAll('.tab-btn').forEach(btn=>{
  btn.addEventListener('click', ()=> tab(btn, btn.dataset.target));
 });

 // Buttons
 document.getElementById('newQuoteBtn').addEventListener('click', newQuote);
 DOM.saveJournalBtn.addEventListener('click', saveJournal);
 DOM.saveSportBtn.addEventListener('click', saveSport);
 DOM.saveBookBtn.addEventListener('click', saveBook);

 // Stat mode
 DOM.weekBtn.addEventListener('click', ()=> switchStat('week'));
 DOM.yearBtn.addEventListener('click', ()=> switchStat('year'));

 // Inputs
 DOM.journal.addEventListener('input', countJournalChars);

 // Image error fallback for large banner
 DOM.motImg.addEventListener('error', ()=>{
  DOM.motImg.src = 'data:image/svg+xml;utf8,' + encodeURIComponent('<svg xmlns="http://www.w3.org/2000/svg" width="800" height="400"><rect width="100%" height="100%" fill="#222"/><text x="50%" y="50%" fill="#ff9800" font-size="24" font-family="Arial" text-anchor="middle" alignment-baseline="middle">K√©p nem el√©rhet≈ë</text></svg>');
 });

 // Image error fallback for author photo
 if(DOM.authorPhoto){
  DOM.authorPhoto.addEventListener('error', ()=>{
   DOM.authorPhoto.src = 'data:image/svg+xml;utf8,' + encodeURIComponent('<svg xmlns="http://www.w3.org/2000/svg" width="100" height="100"><rect width="100%" height="100%" fill="#222"/><circle cx="50" cy="35" r="20" fill="#ff9800"/><rect x="15" y="65" width="70" height="14" fill="#444"/></svg>');
  });
 }

 // Deleg√°lt click listener a szerkeszt√©s/t√∂rl√©s gombokra
 [DOM.statJournalList, DOM.statSportList, DOM.statBookList].forEach(listEl => {
  if(!listEl) return;
  listEl.addEventListener('click', (ev)=>{
   const btn = ev.target.closest('button[data-action]');
   if(!btn) return;
   const action = btn.dataset.action;
   const type = btn.dataset.type;
   const idx = parseInt(btn.dataset.idx, 10);
   if(action === 'edit') openEditModal(type, idx);
   if(action === 'delete') performDelete(type, idx);
  });
 });

 // Modal events
 DOM.modalSaveBtn.addEventListener('click', modalSave);
 DOM.modalCancelBtn.addEventListener('click', closeModal);
 DOM.modalJournal.addEventListener('input', ()=> {
  DOM.modalCharCount.innerText = DOM.modalJournal.value.length;
 });

 // Undo events
 DOM.undoBtn.addEventListener('click', undoLast);
 DOM.undoDismiss.addEventListener('click', hideUndoBar);

 // IO events
 DOM.exportBtn.addEventListener('click', exportData);
 DOM.importBtn.addEventListener('click', ()=> DOM.fileInput.click());
 DOM.fileInput.addEventListener('change', importFile);
}

/* Alap funkci√≥k */
function tab(btn,id){
 document.querySelectorAll(".tabs button").forEach(b=>b.classList.remove("active"));
 btn.classList.add("active");
 document.querySelectorAll(".view").forEach(v=>v.classList.remove("active"));
 document.getElementById(id).classList.add("active");
 if(id==="stat") setTimeout(loadStats,200);
}

/* Friss√≠tett newQuote: mindig pravatar, ha nincs explicit k√©p (itt nincs) */
function newQuote(){
 const q = quotes[Math.floor(Math.random()*quotes.length)];
 if(DOM.quote) DOM.quote.innerText = q.t;
 if(DOM.motImg){
  DOM.motImg.src = q.i;
  DOM.motImg.alt = q.t;
 }
 if(DOM.authorPhoto){
  // mindig pravatar alap√∫ avatar a szerz≈ë neve szerint
  const avatarUrl = 'https://i.pravatar.cc/150?u=' + encodeURIComponent(q.a);
  DOM.authorPhoto.src = avatarUrl;
  DOM.authorPhoto.alt = q.a;
 }
 if(DOM.authorTag) DOM.authorTag.innerText = q.a;
 if(DOM.authorCredit) DOM.authorCredit.innerHTML = '';
 if(DOM.dailyQuote) DOM.dailyQuote.innerText = q.t + " ‚Äì " + q.a;
}

function countJournalChars(){
 if(!DOM.charCount || !DOM.journal || !DOM.saveJournalBtn) return;
 const len = DOM.journal.value.length;
 DOM.charCount.innerText = len;
 DOM.saveJournalBtn.disabled = len < 90;
}

/* Ment√©s funkci√≥k */
function saveJournal(){
 if(!DOM.journal) return;
 const text = DOM.journal.value.trim();
 if(text.length < 90){ alert("A napl√≥nak legal√°bb 90 karakter hossz√∫nak kell lennie."); return; }
 let j = JSON.parse(localStorage.getItem('journal') || "[]");
 j.push({text:text, date:Date.now()});
 localStorage.setItem('journal', JSON.stringify(j));
 DOM.journal.value = "";
 countJournalChars();
 if(document.getElementById('stat').classList.contains('active')) loadStats();
}

function saveSport(){
 if(!DOM.stype) return;
 const type = DOM.stype.value ? DOM.stype.value.trim() : "";
 if(!type){ alert("Adj meg egy edz√©s t√≠pust."); return; }
 let s = JSON.parse(localStorage.getItem('sport') || "[]");
 s.push({type:type, date:Date.now()});
 localStorage.setItem('sport', JSON.stringify(s));
 if(document.getElementById('stat').classList.contains('active')) loadStats();
}

function saveBook(){
 if(!DOM.btitle) return;
 const title = DOM.btitle.value ? DOM.btitle.value.trim() : "";
 if(!title){ alert("Adj meg egy k√∂nyvc√≠met."); return; }
 let b = JSON.parse(localStorage.getItem('book') || "[]");
 b.push({title:title, date:Date.now()});
 localStorage.setItem('book', JSON.stringify(b));
 DOM.btitle.value = "";
 if(document.getElementById('stat').classList.contains('active')) loadStats();
}

/* Stat √©s lista render */
function switchStat(m){
 statMode = m;
 DOM.weekBtn.classList.toggle("active", m==="week");
 DOM.yearBtn.classList.toggle("active", m==="year");
 loadStats();
}

function loadStats(){
 const now = Date.now(), week = 7 * 864e5;
 const j = JSON.parse(localStorage.getItem('journal') || "[]");
 const s = JSON.parse(localStorage.getItem('sport') || "[]");
 const b = JSON.parse(localStorage.getItem('book') || "[]");

 const jWithIdx = j.map((x,i) => ({...x, _idx: i}));
 const sWithIdx = s.map((x,i) => ({...x, _idx: i}));
 const bWithIdx = b.map((x,i) => ({...x, _idx: i}));

 const jf = statMode === "week" ? jWithIdx.filter(x => now - x.date < week) : jWithIdx;
 const sf = statMode === "week" ? sWithIdx.filter(x => now - x.date < week) : sWithIdx;
 const bf = statMode === "week" ? bWithIdx.filter(x => now - x.date < week) : bWithIdx;

 if(DOM.statWrite) DOM.statWrite.innerText = `üìì Napl√≥k: ${jf.length}`;
 if(DOM.statSport) DOM.statSport.innerText = `üèãÔ∏è Edz√©sek: ${sf.length}`;
 if(DOM.statBook) DOM.statBook.innerText = `üìö K√∂nyvek: ${bf.length}`;

 if(statChartObj) statChartObj.destroy();
 if(DOM.statChart){
  statChartObj = new Chart(DOM.statChart, {
   type: "bar",
   data: { labels: ["Napl√≥","Edz√©s","K√∂nyv"], datasets: [{ data: [jf.length, sf.length, bf.length], backgroundColor: ['#ff9800','#ff5722','#9c27b0'] }] },
   options: { responsive:true, maintainAspectRatio:false, plugins:{legend:{display:false}}, scales:{y:{beginAtZero:true}} }
  });
 }

 if(DOM.statJournalList) DOM.statJournalList.innerHTML = jf.map(x => `
  <div class="card">
    ${escapeHtml(truncate(x.text, 200))}
    <div class="entry-meta">${formatDate(x.date)}</div>
    <div class="entry-actions">
      <button class="small-btn small-secondary" data-action="edit" data-type="journal" data-idx="${x._idx}">Szerkeszt</button>
      <button class="small-btn small-danger" data-action="delete" data-type="journal" data-idx="${x._idx}">T√∂r√∂l</button>
    </div>
  </div>`).join("");

 if(DOM.statSportList) DOM.statSportList.innerHTML = sf.map(x => `
  <div class="card">
    ${escapeHtml(x.type)}
    <div class="entry-meta">${formatDate(x.date)}</div>
    <div class="entry-actions">
      <button class="small-btn small-secondary" data-action="edit" data-type="sport" data-idx="${x._idx}">Szerkeszt</button>
      <button class="small-btn small-danger" data-action="delete" data-type="sport" data-idx="${x._idx}">T√∂r√∂l</button>
    </div>
  </div>`).join("");

 if(DOM.statBookList) DOM.statBookList.innerHTML = bf.map(x => `
  <div class="card">
    ${escapeHtml(x.title)}
    <div class="entry-meta">${formatDate(x.date)}</div>
    <div class="entry-actions">
      <button class="small-btn small-secondary" data-action="edit" data-type="book" data-idx="${x._idx}">Szerkeszt</button>
      <button class="small-btn small-danger" data-action="delete" data-type="book" data-idx="${x._idx}">T√∂r√∂l</button>
    </div>
  </div>`).join("");
}

/* Modal szerkeszt√©s */
function openEditModal(type, originalIdx){
 currentEdit = {type, idx: originalIdx};
 DOM.modalFieldJournal.style.display = 'none';
 DOM.modalFieldSport.style.display = 'none';
 DOM.modalFieldBook.style.display = 'none';

 const arr = JSON.parse(localStorage.getItem(type) || "[]");
 const item = arr[originalIdx] || {};
 if(type === 'journal'){
  DOM.modalFieldJournal.style.display = '';
  DOM.modalJournal.value = item.text || '';
  DOM.modalCharCount.innerText = DOM.modalJournal.value.length;
 } else if(type === 'sport'){
  DOM.modalFieldSport.style.display = '';
  DOM.modalSportType.value = item.type || '';
 } else if(type === 'book'){
  DOM.modalFieldBook.style.display = '';
  DOM.modalBookTitle.value = item.title || '';
 }

 DOM.modalBackdrop.style.display = 'flex';
 setTimeout(()=> {
  if(type === 'journal') DOM.modalJournal.focus();
  if(type === 'sport') DOM.modalSportType.focus();
  if(type === 'book') DOM.modalBookTitle.focus();
 }, 50);
}

function closeModal(){
 currentEdit = null;
 DOM.modalBackdrop.style.display = 'none';
}

/* Ment√©s a modalb√≥l */
function modalSave(){
 if(!currentEdit) return;
 const {type, idx} = currentEdit;
 let arr = JSON.parse(localStorage.getItem(type) || "[]");
 if(type === 'journal'){
  const newText = DOM.modalJournal.value.trim();
  if(newText.length < 90){ alert("A napl√≥nak legal√°bb 90 karakter hossz√∫nak kell lennie."); return; }
  if(idx >= 0 && idx < arr.length){
   arr[idx].text = newText;
   arr[idx].date = Date.now();
  } else {
   arr.push({text:newText, date:Date.now()});
  }
 } else if(type === 'sport'){
  const newType = DOM.modalSportType.value.trim();
  if(!newType){ alert("Adj meg egy edz√©s t√≠pust."); return; }
  if(idx >= 0 && idx < arr.length){
   arr[idx].type = newType;
   arr[idx].date = Date.now();
  } else {
   arr.push({type:newType, date:Date.now()});
  }
 } else if(type === 'book'){
  const newTitle = DOM.modalBookTitle.value.trim();
  if(!newTitle){ alert("Adj meg egy k√∂nyvc√≠met."); return; }
  if(idx >= 0 && idx < arr.length){
   arr[idx].title = newTitle;
   arr[idx].date = Date.now();
  } else {
   arr.push({title:newTitle, date:Date.now()});
  }
 }
 localStorage.setItem(type, JSON.stringify(arr));
 closeModal();
 loadStats();
}

/* T√∂rl√©s + undo */
function performDelete(type, originalIdx){
 const key = type;
 let arr = JSON.parse(localStorage.getItem(key) || "[]");
 if(originalIdx < 0 || originalIdx >= arr.length) return;
 const [removed] = arr.splice(originalIdx, 1);
 localStorage.setItem(key, JSON.stringify(arr));
 const undoEntry = {type: key, data: removed, idx: originalIdx};
 undoStack.push(undoEntry);
 DOM.undoMsg.innerText = `T√∂r√∂lve: ${summaryFor(undoEntry)}`;
 showUndoBar();
 loadStats();
 const to = setTimeout(()=> {
  const pos = undoStack.indexOf(undoEntry);
  if(pos >= 0) undoStack.splice(pos,1);
  cleanupUndoBarIfEmpty();
 }, 8000);
 undoTimeouts.push(to);
}

function summaryFor(entry){
 if(!entry) return '';
 if(entry.type === 'journal') return truncate(entry.data.text || '', 40);
 if(entry.type === 'sport') return entry.data.type || '';
 if(entry.type === 'book') return entry.data.title || '';
 return '';
}

function showUndoBar(){
 DOM.undoBar.style.display = 'flex';
}

function hideUndoBar(){
 DOM.undoBar.style.display = 'none';
 undoStack = [];
 undoTimeouts.forEach(t => clearTimeout(t));
 undoTimeouts = [];
}

function cleanupUndoBarIfEmpty(){
 if(undoStack.length === 0){
  DOM.undoBar.style.display = 'none';
  undoTimeouts.forEach(t => clearTimeout(t));
  undoTimeouts = [];
 }
}

function undoLast(){
 if(undoStack.length === 0) return;
 const entry = undoStack.pop();
 if(undoTimeouts.length){
  const t = undoTimeouts.pop();
  clearTimeout(t);
 }
 let arr = JSON.parse(localStorage.getItem(entry.type) || "[]");
 const insertIdx = Math.min(Math.max(0, entry.idx), arr.length);
 arr.splice(insertIdx, 0, entry.data);
 localStorage.setItem(entry.type, JSON.stringify(arr));
 loadStats();
 cleanupUndoBarIfEmpty();
}

/* Export / Import */
function exportData(){
 const payload = {
  journal: JSON.parse(localStorage.getItem('journal') || "[]"),
  sport: JSON.parse(localStorage.getItem('sport') || "[]"),
  book: JSON.parse(localStorage.getItem('book') || "[]"),
  exportedAt: Date.now()
 };
 const blob = new Blob([JSON.stringify(payload, null, 2)], {type:'application/json'});
 const url = URL.createObjectURL(blob);
 const a = document.createElement('a');
 a.href = url;
 const name = `motivacio-app-export-${new Date().toISOString().slice(0,10)}.json`;
 a.download = name;
 document.body.appendChild(a);
 a.click();
 a.remove();
 URL.revokeObjectURL(url);
}

function importFile(ev){
 const f = ev.target.files && ev.target.files[0];
 if(!f) return;
 const reader = new FileReader();
 reader.onload = function(e){
  try{
   const data = JSON.parse(e.target.result);
   if(typeof data !== 'object') throw new Error('Hib√°s f√°jl.');
   const j = Array.isArray(data.journal) ? data.journal : [];
   const s = Array.isArray(data.sport) ? data.sport : [];
   const b = Array.isArray(data.book) ? data.book : [];
   const wantReplace = confirm("Fel√ºl√≠rja a helyi adatokat az import√°ltakkal? (OK = fel√ºl√≠r, M√©gse = √∂sszevon√°s)");
   if(wantReplace){
    localStorage.setItem('journal', JSON.stringify(j));
    localStorage.setItem('sport', JSON.stringify(s));
    localStorage.setItem('book', JSON.stringify(b));
   } else {
    const curJ = JSON.parse(localStorage.getItem('journal') || "[]");
    const curS = JSON.parse(localStorage.getItem('sport') || "[]");
    const curB = JSON.parse(localStorage.getItem('book') || "[]");
    localStorage.setItem('journal', JSON.stringify(curJ.concat(j)));
    localStorage.setItem('sport', JSON.stringify(curS.concat(s)));
    localStorage.setItem('book', JSON.stringify(curB.concat(b)));
   }
   alert("Import sikeres.");
   loadStats();
  }catch(err){
   alert("Import hiba: " + err.message);
  }
 };
 reader.readAsText(f);
 ev.target.value = '';
}

/* Seg√©df√ºggv√©nyek */
function formatDate(ts){
 if(!ts) return "";
 try{
  const d = new Date(ts);
  return d.toLocaleString('hu-HU', {year:'numeric',month:'short',day:'numeric',hour:'2-digit',minute:'2-digit'});
 }catch(e){ return ""; }
}

function truncate(str, max){
 if(!str) return "";
 return str.length > max ? str.slice(0, max-1) + '‚Ä¶' : str;
}

function escapeHtml(str){
 if(!str) return "";
 return String(str)
  .replace(/&/g, '&amp;')
  .replace(/</g, '&lt;')
  .replace(/>/g, '&gt;')
  .replace(/"/g, '&quot;')
  .replace(/'/g, '&#39;');
}

/* Inicializ√°l√°s */
document.addEventListener('DOMContentLoaded', ()=>{
 initDOM();
 newQuote();
 countJournalChars();
 if(document.getElementById('stat').classList.contains('active')) loadStats();
});
</script>
</body>
</html>
